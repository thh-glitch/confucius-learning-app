import React, { useState, useEffect, useRef } from 'react';
import { 
  MapPin, 
  BookOpen, 
  ChevronRight, 
  ChevronLeft, 
  MessageCircle, 
  Award, 
  Users, 
  ShieldAlert,
  Scroll,
  Compass,
  Sparkles,
  Volume2,
  X,
  Send,
  Lightbulb,
  Loader2
} from 'lucide-react';

// --- Gemini API Configuration ---
const apiKey = ""; // System will provide the key at runtime

// æ¨¡æ“¬è³‡æ–™ï¼šå­”å­ç”Ÿå¹³èˆ‡å‘¨éŠåˆ—åœ‹çš„é—œéµéšæ®µ
const JOURNEY_STAGES = [
  {
    id: 'lu-early',
    title: 'åˆä»•é­¯åœ‹ï¼šå¤§æ²»ä¹‹ä¸–',
    location: 'é­¯åœ‹ (Lu)',
    year: 'ç´„å…¬å…ƒå‰ 500 å¹´ (51æ­²)',
    icon: <Award className="w-8 h-8 text-yellow-700" />,
    description: 'å­”å­åœ¨é­¯åœ‹ä»»ä¸­éƒ½å®°ï¼Œå¾Œå‡ä»»å¤§å¸å¯‡ï¼ˆæŒç®¡åˆ‘ç„ç³¾å¯Ÿï¼‰ã€‚ä»–æ¨è¡Œç¦®æ¨‚æ•™åŒ–ï¼Œé­¯åœ‹å¤§æ²»ï¼Œè·¯ä¸æ‹¾éºï¼Œå¤œä¸é–‰æˆ¶ã€‚é½Šåœ‹å› ææ‡¼é­¯åœ‹å¼·å¤§ï¼Œé€ç¾å¥³é§¿é¦¬çµ¦é­¯å®šå…¬ï¼Œå°è‡´å®šå…¬æ²ˆè¿·è²è‰²ï¼Œä¸ç†æœæ”¿ã€‚',
    philosophy: 'ã€Œé“ä¹‹ä»¥æ”¿ï¼Œé½Šä¹‹ä»¥åˆ‘ï¼Œæ°‘å…è€Œç„¡æ¥ï¼›é“ä¹‹ä»¥å¾·ï¼Œé½Šä¹‹ä»¥ç¦®ï¼Œæœ‰æ¥ä¸”æ ¼ã€‚ã€',
    philosophyMeaning: 'æ”¿æ²»ç†å¿µï¼šä¸»å¼µä»¥å¾·æ²»åœ‹ï¼Œè€Œéå–®ç´”ä¾é åˆ‘ç½°ã€‚',
    discussion: 'å¦‚æœä½ æ˜¯å­”å­ï¼Œçœ‹åˆ°åœ‹å›æ²ˆè¿·ç©æ¨‚ä¸å†ä¿¡ä»»ä½ ï¼Œä½ æœƒé¸æ“‡ç•™ä¸‹ä¾†ç¹¼çºŒå‹¸è««ï¼Œé‚„æ˜¯é›¢é–‹å°‹æ‰¾æ–°æ©Ÿæœƒï¼Ÿç‚ºä»€éº¼ï¼Ÿ',
    mapCoords: { x: 80, y: 30 }
  },
  {
    id: 'departure',
    title: 'è¢«è¿«å»è·ï¼šå‘¨éŠä¹‹å§‹',
    location: 'é›¢é–‹é­¯åœ‹',
    year: 'ç´„å…¬å…ƒå‰ 497 å¹´ (55æ­²)',
    icon: <Compass className="w-8 h-8 text-gray-600" />,
    description: 'å› é­¯å®šå…¬æ²ˆè¿·é½Šåœ‹é€ä¾†çš„å¥³æ¨‚ï¼Œä¸¦åœ¨éƒŠç¥­æ™‚é•èƒŒç¦®åˆ¶ï¼ˆä¸åˆ†é€ç¥­è‚‰çµ¦å¤§å¤«ï¼‰ï¼Œå­”å­æ·±æ„Ÿå¤±æœ›ï¼Œæ±ºå®šé›¢é–‹çˆ¶æ¯ä¹‹é‚¦ï¼Œé–‹å§‹äº†é•·é”åå››å¹´çš„å‘¨éŠåˆ—åœ‹ç”Ÿæ¶¯ï¼Œå°‹æ‰¾èƒ½å¯¦è¸ã€Œä»æ”¿ã€çš„å›ä¸»ã€‚',
    philosophy: 'ã€Œå£«å¿—æ–¼é“ï¼Œè€Œæ¥æƒ¡è¡£æƒ¡é£Ÿè€…ï¼Œæœªè¶³èˆ‡è­°ä¹Ÿã€‚ã€',
    philosophyMeaning: 'å¿ƒæ…‹å±•ç¾ï¼šè®€æ›¸äººç«‹å¿—æ–¼çœŸç†ï¼Œä¸æ‡‰ä»¥ç‰©è³ªç”Ÿæ´»çš„è²§ä¹ç‚ºæ¥ã€‚',
    discussion: 'å­”å­é›¢é–‹æ™‚å·²ç¶“50å¤šæ­²äº†ï¼Œç‚ºä»€éº¼ä»–é¡˜æ„æ”¾æ£„ç©©å®šçš„é«˜å®˜åšç¥¿ï¼Œå»é¢å°æœªçŸ¥çš„æµæµªç”Ÿæ´»ï¼Ÿ',
    mapCoords: { x: 70, y: 40 }
  },
  {
    id: 'wei',
    title: 'å±…è¡›æœŸé–“ï¼šéš›é‡æµ®æ²ˆ',
    location: 'è¡›åœ‹ (Wei)',
    year: 'å¤šæ¬¡é€²å‡ºè¡›åœ‹',
    icon: <Users className="w-8 h-8 text-blue-700" />,
    description: 'è¡›éˆå…¬é›–ç„¶ç¦®é‡å­”å­ï¼Œçµ¦äºˆé«˜è–ªï¼Œä½†ä¸¦ä¸é‡ç”¨å…¶æ”¿æ²»ä¸»å¼µï¼Œä¸”è¡›åœ‹æ”¿æ²»æ··äº‚ï¼ˆå¦‚ã€Œå—å­ã€äº‹ä»¶ï¼‰ã€‚å­”å­æ„Ÿå˜†ã€Œå¾æœªè¦‹å¥½å¾·å¦‚å¥½è‰²è€…ä¹Ÿã€ï¼Œæ„è­˜åˆ°é€™è£¡ç„¡æ³•å¯¦è¸ç†æƒ³ã€‚',
    philosophy: 'ã€Œè‹Ÿæœ‰ç”¨æˆ‘è€…ï¼ŒæœŸæœˆè€Œå·²å¯ä¹Ÿï¼Œä¸‰å¹´æœ‰æˆã€‚ã€',
    philosophyMeaning: 'æ”¿æ²»è‡ªä¿¡ï¼šåªè¦æœ‰äººè‚¯é‡ç”¨æˆ‘ï¼Œä¸€å¹´å°±èƒ½çœ‹åˆ°æˆæ•ˆï¼Œä¸‰å¹´å°±èƒ½å¤§åŠŸå‘Šæˆã€‚å¯æƒœç„¡äººé‡ç”¨ã€‚',
    discussion: 'è¡›éˆå…¬çµ¦å­”å­å¾ˆé«˜çš„è–ªæ°´å»ä¸çµ¦å¯¦æ¬Šã€‚åœ¨ç¾ä»£è·å ´ä¸­ï¼Œä½ æœƒé¸æ“‡ã€Œé«˜è–ªä½†ç„¡å¯¦æ¬Šã€é‚„æ˜¯ã€Œä½è–ªä½†èƒ½ç™¼æ®ç†æƒ³ã€çš„å·¥ä½œï¼Ÿ',
    mapCoords: { x: 60, y: 20 }
  },
  {
    id: 'song',
    title: 'éå®‹ä¹‹å„ï¼šå¾®æœéå®‹',
    location: 'å®‹åœ‹ (Song)',
    year: 'å‘¨éŠé€”ä¸­',
    icon: <ShieldAlert className="w-8 h-8 text-red-600" />,
    description: 'å­”å­ç¶“éå®‹åœ‹æ™‚ï¼Œåœ¨å¤§æ¨¹ä¸‹æ¼”ç¿’ç¦®å„€ã€‚å®‹åœ‹å¸é¦¬æ¡“é­‹ï¼ˆtuÃ­ï¼‰æƒ³æ®ºå­”å­ï¼ŒæŠŠå¤§æ¨¹ç å€’ã€‚å¼Ÿå­å€‘å‚¬ä¿ƒå­”å­å¿«è·‘ï¼Œå­”å­å»å±•ç¾äº†æ¥µé«˜çš„å®šåŠ›èˆ‡å¤©å‘½è§€ã€‚',
    philosophy: 'ã€Œå¤©ç”Ÿå¾·æ–¼äºˆï¼Œæ¡“é­‹å…¶å¦‚äºˆä½•ï¼Ÿã€',
    philosophyMeaning: 'å¤©å‘½è§€ï¼šä¸Šå¤©æŠŠå“å¾·è³¦äºˆäº†æˆ‘ï¼Œæ¡“é­‹èƒ½æŠŠæˆ‘æ€éº¼æ¨£å‘¢ï¼Ÿå±•ç¾è‡¨å±ä¸äº‚çš„å‹‡æ°£ã€‚',
    discussion: 'ç•¶ç”Ÿå‘½å—åˆ°å¨è„…æ™‚ï¼Œå­”å­ç‚ºä»€éº¼é‚„èƒ½é€™éº¼é®å®šï¼Ÿé€™ç¨®è‡ªä¿¡å¾ä½•è€Œä¾†ï¼Ÿ',
    mapCoords: { x: 50, y: 50 }
  },
  {
    id: 'chen-cai',
    title: 'é™³è”¡çµ•ç³§ï¼šå›°å¢ƒè€ƒé©—',
    location: 'é™³åœ‹èˆ‡è”¡åœ‹ä¹‹é–“ (Chen/Cai)',
    year: 'ç´„å…¬å…ƒå‰ 489 å¹´',
    icon: <ShieldAlert className="w-8 h-8 text-orange-700" />,
    description: 'å­”å­ä¸€è¡Œäººåœ¨é™³åœ‹å’Œè”¡åœ‹ä¹‹é–“è¢«è»éšŠåœå›°ï¼Œç³§é£Ÿæ–·çµ•ï¼Œè·Ÿéš¨çš„å¼Ÿå­è¨±å¤šéƒ½é¤“ç—…äº†ã€‚å­è·¯ç”Ÿæ°£åœ°å•ï¼šã€Œå›å­ä¹Ÿæœ‰çª®å›°çš„æ™‚å€™å—ï¼Ÿã€å­”å­ä»¥æ­¤æ•™å°å¼Ÿå­å›å­èˆ‡å°äººåœ¨é¢å°å›°å¢ƒæ™‚çš„å·®åˆ¥ã€‚',
    philosophy: 'ã€Œå›å­å›ºçª®ï¼Œå°äººçª®æ–¯æ¿«çŸ£ã€‚ã€',
    philosophyMeaning: 'é“å¾·ä¿®é¤Šï¼šå›å­åœ¨å›°çª˜æ™‚ä»èƒ½å …å®ˆç¯€æ“ï¼Œå°äººä¸€é‡åˆ°å›°çª˜å°±æœƒèƒ¡ä½œéç‚ºã€‚',
    discussion: 'é€™æ˜¯å­”å­æœ€è½é­„çš„æ™‚åˆ»ã€‚æ›ä½œæ˜¯ä¸€èˆ¬äººï¼Œåœ¨é¤“è‚šå­æ™‚å¯èƒ½å°±æœƒæ”¾æ£„åŸå‰‡ã€‚ä½ èªç‚ºæ˜¯ä»€éº¼åŠ›é‡æ”¯æ’è‘—ä»–å€‘ï¼Ÿ',
    mapCoords: { x: 40, y: 60 }
  },
  {
    id: 'return',
    title: 'æ™šå¹´æ­¸é­¯ï¼šåˆªè¿°å…­ç¶“',
    location: 'å›åˆ°é­¯åœ‹ (Lu)',
    year: 'ç´„å…¬å…ƒå‰ 484 å¹´ (68æ­²)',
    icon: <Scroll className="w-8 h-8 text-green-700" />,
    description: 'åœ¨å­£åº·å­çš„é‚€è«‹ä¸‹ï¼Œ68æ­²çš„å­”å­çµ‚æ–¼å›åˆ°é­¯åœ‹ã€‚ä»–ä¸å†å°‹æ±‚ä»•é€”ï¼Œè€Œæ˜¯å°ˆæ³¨æ–¼æ•™è‚²èˆ‡æ•´ç†å¤ç±ã€‚ä»–åˆªè©©æ›¸ã€å®šç¦®æ¨‚ã€è´Šå‘¨æ˜“ã€ä½œæ˜¥ç§‹ï¼Œå¼Ÿå­å¤šé”ä¸‰åƒäººï¼Œèº«é€šå…­è—è€…ä¸ƒåäºŒäººï¼Œå°ä¸­è¯æ–‡åŒ–ç”¢ç”Ÿæ·±é å½±éŸ¿ã€‚',
    philosophy: 'ã€Œç™¼æ†¤å¿˜é£Ÿï¼Œæ¨‚ä»¥å¿˜æ†‚ï¼Œä¸çŸ¥è€ä¹‹å°‡è‡³äº‘çˆ¾ã€‚ã€',
    philosophyMeaning: 'çµ‚èº«å­¸ç¿’ï¼šå½¢å®¹è‡ªå·±å‹¤å¥®å­¸ç¿’åˆ°å¿˜è¨˜åƒé£¯ï¼Œå¿«æ¨‚åˆ°å¿˜è¨˜æ†‚æ„ï¼Œç”šè‡³ä¸çŸ¥é“è¡°è€å³å°‡åˆ°ä¾†ã€‚',
    discussion: 'å­”å­é›–ç„¶æ²’æœ‰åœ¨æ”¿æ²»ä¸Šå¯¦ç¾ç†æƒ³ï¼Œä½†ä»–åœ¨æ•™è‚²ä¸Šçš„æˆå°±å½±éŸ¿äº†å¾Œä¸–å…©åƒå¤šå¹´ã€‚é€™çµ¦æˆ‘å€‘å°æ–¼ã€ŒæˆåŠŸã€çš„å®šç¾©æœ‰ä»€éº¼å•Ÿç™¼ï¼Ÿ',
    mapCoords: { x: 80, y: 45 }
  }
];

// Helper: Text Generation
async function generateGeminiText(prompt, systemInstruction) {
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          systemInstruction: { parts: [{ text: systemInstruction }] }
        })
      }
    );
    
    if (!response.ok) throw new Error(`API call failed: ${response.status}`);
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨ç„¡æ³•å›ç­”ã€‚";
  } catch (e) {
    console.error(e);
    return "ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
  }
}

// Helper: Text to Speech
async function generateGeminiSpeech(text) {
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: text }] }],
          generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: {
              voiceConfig: {
                prebuiltVoiceConfig: {
                  voiceName: "Orus" // Deep, calm male voice
                }
              }
            }
          }
        })
      }
    );

    if (!response.ok) throw new Error('TTS failed');
    const data = await response.json();
    const audioData = data.candidates[0].content.parts[0].inlineData.data;
    
    // Convert base64 PCM to audio (Browsers usually need WAV/MP3 container, but Chrome often plays raw if hinted, 
    // or we can use a simple WAV header. For simplicity in this demo, we assume valid output container or basic PCM handling
    // Note: The API returns raw PCM. For proper playback in browser without libs, we need to wrap it or use AudioContext.
    // To keep this single-file and simple, we will use a data URI approach if the API returns a format the browser guesses,
    // otherwise we use a simple WAV header wrapper function.)
    
    return audioData;
  } catch (e) {
    console.error(e);
    return null;
  }
}

// Helper to add WAV header to PCM data (Standard 24kHz mono from Gemini typically)
function pcmToWav(base64PCM) {
  const binaryString = window.atob(base64PCM);
  const len = binaryString.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);

  const wavHeader = new ArrayBuffer(44);
  const view = new DataView(wavHeader);
  
  // RIFF chunk descriptor
  view.setUint8(0, 'R'.charCodeAt(0));
  view.setUint8(1, 'I'.charCodeAt(0));
  view.setUint8(2, 'F'.charCodeAt(0));
  view.setUint8(3, 'F'.charCodeAt(0));
  view.setUint32(4, 36 + len, true);
  view.setUint8(8, 'W'.charCodeAt(0));
  view.setUint8(9, 'A'.charCodeAt(0));
  view.setUint8(10, 'V'.charCodeAt(0));
  view.setUint8(11, 'E'.charCodeAt(0));
  
  // fmt sub-chunk
  view.setUint8(12, 'f'.charCodeAt(0));
  view.setUint8(13, 'm'.charCodeAt(0));
  view.setUint8(14, 't'.charCodeAt(0));
  view.setUint8(15, ' '.charCodeAt(0));
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true); // PCM
  view.setUint16(22, 1, true); // Mono
  view.setUint32(24, 24000, true); // Sample Rate
  view.setUint32(28, 24000 * 2, true); // Byte Rate
  view.setUint16(32, 2, true); // Block Align
  view.setUint16(34, 16, true); // Bits per sample
  
  // data sub-chunk
  view.setUint8(36, 'd'.charCodeAt(0));
  view.setUint8(37, 'a'.charCodeAt(0));
  view.setUint8(38, 't'.charCodeAt(0));
  view.setUint8(39, 'a'.charCodeAt(0));
  view.setUint32(40, len, true);

  const blob = new Blob([view, bytes], { type: 'audio/wav' });
  return URL.createObjectURL(blob);
}


export default function ConfuciusJourneyApp() {
  const [currentStageIndex, setCurrentStageIndex] = useState(0);
  const [showDiscussion, setShowDiscussion] = useState(false);
  const [animateMap, setAnimateMap] = useState(false);

  // AI Features State
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [chatMessage, setChatMessage] = useState('');
  const [chatHistory, setChatHistory] = useState([]);
  const [isChatLoading, setIsChatLoading] = useState(false);
  
  const [modernAnalogy, setModernAnalogy] = useState(null);
  const [isAnalogyLoading, setIsAnalogyLoading] = useState(false);
  
  const [isSpeaking, setIsSpeaking] = useState(false);
  const audioRef = useRef(null);
  const chatEndRef = useRef(null);

  const currentStage = JOURNEY_STAGES[currentStageIndex];
  const isFirst = currentStageIndex === 0;
  const isLast = currentStageIndex === JOURNEY_STAGES.length - 1;

  useEffect(() => {
    setAnimateMap(true);
    setModernAnalogy(null); // Reset analogy on stage change
    setChatHistory([]); // Reset chat on stage change
    if(audioRef.current) {
        audioRef.current.pause();
        setIsSpeaking(false);
    }
    const timer = setTimeout(() => setAnimateMap(false), 1000);
    return () => clearTimeout(timer);
  }, [currentStageIndex]);

  useEffect(() => {
    if (chatEndRef.current) {
      chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [chatHistory, isChatOpen]);

  const handleNext = () => {
    if (!isLast) {
      setCurrentStageIndex(prev => prev + 1);
      setShowDiscussion(false);
    }
  };

  const handlePrev = () => {
    if (!isFirst) {
      setCurrentStageIndex(prev => prev - 1);
      setShowDiscussion(false);
    }
  };

  // AI Handlers
  const handleAskConfucius = async (e) => {
    e.preventDefault();
    if (!chatMessage.trim()) return;

    const userMsg = { role: 'user', text: chatMessage };
    setChatHistory(prev => [...prev, userMsg]);
    setChatMessage('');
    setIsChatLoading(true);

    const systemPrompt = `
      ä½ ç¾åœ¨æ‰®æ¼”å­”å­ï¼ˆå­”ä¸˜ï¼‰ã€‚
      è«‹æ³¨æ„ï¼Œä½ ç¾åœ¨æ­£è™•æ–¼äººç”Ÿçš„é€™å€‹éšæ®µï¼š${currentStage.title} - ${currentStage.description}ã€‚
      åœ°é»ï¼š${currentStage.location}ã€‚
      
      è«‹ç”¨ä¸€ä½å……æ»¿æ™ºæ…§ã€æ…ˆæ‚²ä½†å¶çˆ¾æœƒæ„Ÿå˜†ä¸–é“ä¸å…¬çš„é•·è€…èªæ°£å›ç­”å­¸ç”Ÿçš„å•é¡Œã€‚
      å¦‚æœå­¸ç”Ÿçš„å•é¡Œèˆ‡ä½ ç¾åœ¨çš„è™•å¢ƒç„¡é—œï¼Œè©¦è‘—ç”¨å„’å®¶çš„æ™ºæ…§å°‡å…¶é€£çµå›ä¾†ã€‚
      å›ç­”è¦ç°¡æ½”æœ‰åŠ›ï¼Œé©åˆèª²å ‚äº’å‹•ã€‚å¯ä»¥ä½¿ç”¨ã€Œå¾ã€è‡ªç¨±ã€‚
    `;

    const aiResponseText = await generateGeminiText(chatMessage, systemPrompt);
    
    setChatHistory(prev => [...prev, { role: 'ai', text: aiResponseText }]);
    setIsChatLoading(false);
  };

  const handleGenerateAnalogy = async () => {
    setIsAnalogyLoading(true);
    const systemPrompt = "ä½ æ˜¯ä¸€ä½æ“…é•·å°‡å¤ä»£å“²å­¸é€£çµåˆ°ç¾ä»£ç”Ÿæ´»çš„è€å¸«ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚";
    const prompt = `
      è«‹é‡å°å­”å­çš„é€™å¥åè¨€ï¼šã€Œ${currentStage.philosophy}ã€
      ï¼ˆå…¶å«ç¾©ç‚ºï¼š${currentStage.philosophyMeaning}ï¼‰
      
      ç”Ÿæˆä¸€å€‹ã€Œç¾ä»£ç”Ÿæ´»ã€æˆ–ã€Œè·å ´ã€çš„é¡æ¯”ï¼Œè®“ä¸­å­¸ç”Ÿèƒ½ç§’æ‡‚ã€‚
      è«‹ç”¨ä¸€å€‹ç°¡çŸ­çš„æ®µè½è§£é‡‹ï¼Œé–‹é ­ç”¨ã€Œâœ¨ ç¾ä»£è§£è®€ï¼šã€ã€‚
    `;
    
    const text = await generateGeminiText(prompt, systemPrompt);
    setModernAnalogy(text);
    setIsAnalogyLoading(false);
  };

  const handleSpeakQuote = async () => {
    if (isSpeaking) {
      if (audioRef.current) audioRef.current.pause();
      setIsSpeaking(false);
      return;
    }

    setIsSpeaking(true);
    // Remove punctuation for cleaner TTS flow if needed, but keeping it is usually better for intonation
    const textToSpeak = `å­”å­æ›°ï¼š${currentStage.philosophy}`; 
    
    const pcmData = await generateGeminiSpeech(textToSpeak);
    if (pcmData) {
      const wavUrl = pcmToWav(pcmData);
      const audio = new Audio(wavUrl);
      audioRef.current = audio;
      audio.onended = () => setIsSpeaking(false);
      audio.play();
    } else {
      setIsSpeaking(false);
      alert("èªéŸ³ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    }
  };


  return (
    <div className="min-h-screen bg-stone-100 text-stone-800 font-sans selection:bg-amber-200">
      {/* Header */}
      <header className="bg-stone-900 text-amber-50 p-4 shadow-md sticky top-0 z-10">
        <div className="max-w-5xl mx-auto flex justify-between items-center">
          <div className="flex items-center space-x-3">
            <BookOpen className="w-6 h-6 text-amber-400" />
            <h1 className="text-xl font-bold tracking-widest">è‡³è–å…ˆå¸«ï¼šå­”å­å‘¨éŠåˆ—åœ‹äº’å‹•åœ–</h1>
          </div>
          <div className="flex items-center space-x-4">
            <div className="text-sm text-stone-400 hidden sm:block">
              æ˜¥ç§‹æ™‚æœŸ (770â€“476 BC)
            </div>
            <button 
              onClick={() => setIsChatOpen(true)}
              className="bg-amber-600 hover:bg-amber-500 text-white px-3 py-1.5 rounded-full text-sm font-bold flex items-center gap-2 transition-colors shadow-lg border border-amber-400"
            >
              <Sparkles className="w-4 h-4" />
              å•å­”å­
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        {/* Left Column: Map & Navigation */}
        <div className="lg:col-span-1 flex flex-col space-y-6">
          
          {/* Map Visualization */}
          <div className="bg-white p-4 rounded-xl shadow-sm border-2 border-stone-200 relative overflow-hidden">
            <h3 className="text-stone-500 font-bold mb-4 flex items-center">
              <MapPin className="w-4 h-4 mr-2" /> è¡Œç¨‹åœ°åœ–ç¤ºæ„
            </h3>
            <div className="aspect-square bg-amber-50/50 rounded-lg relative border border-amber-100">
              <svg viewBox="0 0 100 100" className="w-full h-full absolute top-0 left-0 pointer-events-none">
                <path 
                  d="M 80 30 L 70 40 L 60 20 L 50 50 L 40 60 L 80 45" 
                  fill="none" stroke="#d6d3d1" strokeWidth="2" strokeDasharray="4"
                />
                <path 
                  d={`M 80 30 ${currentStageIndex > 0 ? 'L 70 40' : ''} ${currentStageIndex > 1 ? 'L 60 20' : ''} ${currentStageIndex > 2 ? 'L 50 50' : ''} ${currentStageIndex > 3 ? 'L 40 60' : ''} ${currentStageIndex > 4 ? 'L 80 45' : ''}`}
                  fill="none" stroke="#b45309" strokeWidth="3"
                  className="transition-all duration-1000 ease-in-out"
                />
                {JOURNEY_STAGES.map((stage, idx) => (
                  <circle
                    key={stage.id} cx={stage.mapCoords.x} cy={stage.mapCoords.y}
                    r={currentStageIndex === idx ? 4 : 2}
                    fill={currentStageIndex === idx ? "#b45309" : "#78716c"}
                    className="transition-all duration-500"
                  />
                ))}
                <circle cx={currentStage.mapCoords.x} cy={currentStage.mapCoords.y} r="6" stroke="#b45309" strokeWidth="1" fill="none" className="animate-ping opacity-75" />
              </svg>

              {JOURNEY_STAGES.map((stage, idx) => (
                <div 
                  key={stage.id}
                  className={`absolute transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold transition-all duration-500 cursor-pointer
                    ${currentStageIndex === idx ? 'text-amber-700 scale-110 z-10 bg-white px-2 py-1 rounded shadow-sm border border-amber-200' : 'text-stone-400 scale-90 hover:text-stone-600'}
                  `}
                  style={{ left: `${stage.mapCoords.x}%`, top: `${stage.mapCoords.y + 8}%` }}
                  onClick={() => { setCurrentStageIndex(idx); setShowDiscussion(false); }}
                >
                  {stage.location.split(' ')[0]}
                </div>
              ))}
            </div>
          </div>

          {/* Progress List */}
          <div className="bg-white rounded-xl shadow-sm border border-stone-200 p-4 hidden lg:block">
            <h3 className="text-stone-500 font-bold mb-4">ç”Ÿå‘½æ­·ç¨‹</h3>
            <ul className="space-y-0 relative">
              <div className="absolute left-3 top-2 bottom-2 w-0.5 bg-stone-200"></div>
              {JOURNEY_STAGES.map((stage, idx) => (
                <li key={stage.id} className="relative pl-8 py-2">
                  <div className={`absolute left-[0.65rem] top-3.5 w-2.5 h-2.5 rounded-full border-2 ${idx <= currentStageIndex ? 'bg-amber-600 border-amber-600' : 'bg-white border-stone-300'}`}></div>
                  <button 
                    onClick={() => { setCurrentStageIndex(idx); setShowDiscussion(false); }}
                    className={`text-left w-full text-sm hover:text-amber-700 transition-colors ${currentStageIndex === idx ? 'font-bold text-amber-800' : 'text-stone-500'}`}
                  >
                    {stage.title}
                  </button>
                </li>
              ))}
            </ul>
          </div>
        </div>

        {/* Center/Right Column: Main Content */}
        <div className="lg:col-span-2 flex flex-col">
          
          {/* Content Card */}
          <div className="bg-white rounded-2xl shadow-lg border-t-4 border-amber-700 flex-grow overflow-hidden flex flex-col">
            
            {/* Top Banner */}
            <div className="h-32 bg-stone-800 relative overflow-hidden flex items-center justify-center">
              <div className="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')]"></div>
              <div className="text-center z-10 px-4">
                <div className="text-amber-400 text-sm font-serif tracking-widest uppercase mb-1">{currentStage.year}</div>
                <h2 className="text-3xl md:text-4xl font-serif font-bold text-white tracking-wide">{currentStage.title}</h2>
              </div>
            </div>

            <div className="p-6 md:p-8 flex-grow flex flex-col space-y-6">
              
              {/* Location Header */}
              <div className="flex items-center space-x-4 border-b border-stone-100 pb-4">
                <div className="p-3 bg-amber-50 rounded-full border border-amber-100">
                  {currentStage.icon}
                </div>
                <div>
                  <div className="text-xs font-bold text-stone-400 uppercase tracking-wider">ç•¶å‰æ‰€åœ¨åœ°</div>
                  <div className="text-xl font-bold text-stone-800">{currentStage.location}</div>
                </div>
              </div>

              {/* Description */}
              <div className="prose prose-stone max-w-none">
                <p className="text-lg leading-relaxed text-stone-700">
                  {currentStage.description}
                </p>
              </div>

              {/* Philosophy Section with AI Features */}
              <div className="bg-stone-50 p-6 rounded-lg border-l-4 border-amber-600 my-4 space-y-4">
                <div className="flex items-start justify-between">
                  <div className="flex items-start">
                    <Scroll className="w-6 h-6 text-amber-600 mr-3 mt-1 flex-shrink-0" />
                    <div>
                      <p className="text-xl font-serif font-medium text-stone-800 italic mb-2">
                        {currentStage.philosophy}
                      </p>
                      <p className="text-sm text-stone-500 font-sans">
                        <span className="font-bold text-amber-700">é‡‹ç¾©ï¼š</span> {currentStage.philosophyMeaning}
                      </p>
                    </div>
                  </div>
                </div>

                {/* AI Action Buttons for Quote */}
                <div className="flex flex-wrap gap-3 pl-9">
                  <button 
                    onClick={handleSpeakQuote}
                    className={`flex items-center text-xs px-3 py-1.5 rounded border transition-colors
                      ${isSpeaking ? 'bg-red-100 text-red-700 border-red-200' : 'bg-white text-stone-600 border-stone-200 hover:bg-stone-100'}
                    `}
                  >
                    {isSpeaking ? <Loader2 className="w-3 h-3 mr-1 animate-spin" /> : <Volume2 className="w-3 h-3 mr-1" />}
                    {isSpeaking ? 'æ’­æ”¾ä¸­...' : 'âœ¨ è†è½è–è¨€'}
                  </button>

                  <button 
                    onClick={handleGenerateAnalogy}
                    disabled={isAnalogyLoading}
                    className="flex items-center text-xs px-3 py-1.5 rounded bg-white text-indigo-600 border border-indigo-100 hover:bg-indigo-50 transition-colors"
                  >
                    {isAnalogyLoading ? <Loader2 className="w-3 h-3 mr-1 animate-spin" /> : <Lightbulb className="w-3 h-3 mr-1" />}
                    âœ¨ ç¾ä»£è§£è®€
                  </button>
                </div>

                {/* AI Generated Analogy Result */}
                {modernAnalogy && (
                  <div className="mt-3 ml-9 p-3 bg-indigo-50 rounded text-sm text-indigo-800 animate-in fade-in slide-in-from-top-2">
                    {modernAnalogy}
                  </div>
                )}
              </div>

              {/* Discussion Section */}
              <div className="mt-auto pt-4">
                <button 
                  onClick={() => setShowDiscussion(!showDiscussion)}
                  className="w-full flex items-center justify-center space-x-2 py-3 px-4 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-lg transition-colors border border-indigo-200 group"
                >
                  <MessageCircle className="w-5 h-5 group-hover:scale-110 transition-transform" />
                  <span className="font-bold">
                    {showDiscussion ? 'éš±è—èª²å ‚è¨è«–' : 'é¡¯ç¤ºèª²å ‚è¨è«–å•é¡Œ (è€å¸«å°ˆç”¨)'}
                  </span>
                </button>

                {showDiscussion && (
                  <div className="mt-4 p-6 bg-indigo-600 text-white rounded-xl shadow-inner animate-in fade-in slide-in-from-top-4 duration-300">
                    <h4 className="font-bold text-indigo-200 mb-2 text-sm uppercase tracking-wider">å¼•å°æ€è€ƒ</h4>
                    <p className="text-lg font-medium leading-relaxed">
                      {currentStage.discussion}
                    </p>
                  </div>
                )}
              </div>
            </div>

            {/* Footer Nav */}
            <div className="bg-stone-100 p-4 border-t border-stone-200 flex justify-between items-center">
              <button 
                onClick={handlePrev}
                disabled={isFirst}
                className={`flex items-center space-x-2 px-4 py-2 rounded-lg font-bold transition-colors
                  ${isFirst ? 'text-stone-300 cursor-not-allowed' : 'bg-white text-stone-700 hover:bg-amber-50 hover:text-amber-800 shadow-sm border border-stone-300'}`}
              >
                <ChevronLeft className="w-5 h-5" />
                <span>ä¸Šä¸€éšæ®µ</span>
              </button>

              <div className="text-stone-400 text-sm font-medium">
                {currentStageIndex + 1} / {JOURNEY_STAGES.length}
              </div>

              <button 
                onClick={handleNext}
                disabled={isLast}
                className={`flex items-center space-x-2 px-4 py-2 rounded-lg font-bold transition-colors
                  ${isLast ? 'text-stone-300 cursor-not-allowed' : 'bg-stone-800 text-white hover:bg-stone-700 shadow-md'}`}
              >
                <span>ä¸‹ä¸€éšæ®µ</span>
                <ChevronRight className="w-5 h-5" />
              </button>
            </div>
          </div>
        </div>
      </main>

      {/* Chat Modal */}
      {isChatOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md h-[600px] flex flex-col overflow-hidden animate-in fade-in zoom-in-95 duration-200">
            {/* Chat Header */}
            <div className="bg-amber-800 text-white p-4 flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-white/10 rounded-full">
                  <Sparkles className="w-5 h-5 text-amber-300" />
                </div>
                <div>
                  <h3 className="font-bold">å•å­”å­</h3>
                  <p className="text-xs text-amber-200 opacity-80">ç•¶å‰ï¼š{currentStage.location}</p>
                </div>
              </div>
              <button onClick={() => setIsChatOpen(false)} className="text-white/70 hover:text-white">
                <X className="w-6 h-6" />
              </button>
            </div>

            {/* Chat Messages */}
            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-stone-50">
              {chatHistory.length === 0 && (
                <div className="text-center py-10 text-stone-400 px-6">
                  <p className="mb-2 text-4xl">ğŸ“œ</p>
                  <p>å¾ä¹ƒå­”ä¸˜ã€‚æ±æœ‰ä½•æƒ‘ï¼Ÿ</p>
                  <p className="text-xs mt-2 text-stone-300">(è«‹æ ¹æ“šç•¶å‰æ­·å²éšæ®µæå•)</p>
                </div>
              )}
              {chatHistory.map((msg, i) => (
                <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div 
                    className={`max-w-[80%] p-3 rounded-2xl text-sm shadow-sm
                      ${msg.role === 'user' 
                        ? 'bg-amber-600 text-white rounded-br-none' 
                        : 'bg-white text-stone-800 border border-stone-200 rounded-bl-none'
                      }`}
                  >
                    {msg.text}
                  </div>
                </div>
              ))}
              {isChatLoading && (
                <div className="flex justify-start">
                  <div className="bg-white p-3 rounded-2xl rounded-bl-none shadow-sm border border-stone-200 flex items-center gap-2 text-stone-400 text-sm">
                    <Loader2 className="w-4 h-4 animate-spin" /> 
                    <span>å­”å­æ²ˆæ€ä¸­...</span>
                  </div>
                </div>
              )}
              <div ref={chatEndRef} />
            </div>

            {/* Chat Input */}
            <form onSubmit={handleAskConfucius} className="p-4 bg-white border-t border-stone-100">
              <div className="flex gap-2">
                <input 
                  type="text" 
                  value={chatMessage}
                  onChange={(e) => setChatMessage(e.target.value)}
                  placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..."
                  className="flex-1 px-4 py-2 bg-stone-100 rounded-full focus:outline-none focus:ring-2 focus:ring-amber-500 border-transparent text-sm"
                />
                <button 
                  type="submit"
                  disabled={isChatLoading || !chatMessage.trim()}
                  className="p-2 bg-amber-600 text-white rounded-full hover:bg-amber-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                  <Send className="w-5 h-5" />
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}