<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡³è–å…ˆå¸«ï¼šå­”å­å‘¨éŠåˆ—åœ‹äº’å‹•åœ–</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        'paper': '#fdfbf7',
                        'ink': '#1c1917',
                        'seal-red': '#b91c1c',
                        'jade': '#376e6f',
                        'gold': '#d97706',
                    },
                    backgroundImage: {
                        'texture': "url('https://www.transparenttextures.com/patterns/cream-paper.png')",
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fdfbf7;
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
        }
        /* Custom Scrollbar for Chat */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .prose p {
            margin-bottom: 1em;
            line-height: 1.8;
        }
    </style>
</head>
<body class="text-ink font-sans antialiased selection:bg-gold selection:text-white">

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- Gemini API Configuration ---
    // è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ API Keyï¼Œæˆ–è€…åœ¨ä»‹é¢ä¸Šä¸æœƒé¡¯ç¤ºï¼Œä½†åŠŸèƒ½éœ€è¦ Key æ‰èƒ½é‹ä½œ
    const apiKey = ""; 

    // --- Icons Component (Standalone SVG replacement for Lucide) ---
    const Icons = {
        MapPin: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
        BookOpen: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
        ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
        ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
        MessageCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
        Award: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>,
        Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
        ShieldAlert: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
        Scroll: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 4c0-1.1-.9-2-2-2H6a2 2 0 0 0-2 2v15a3 3 0 0 0 3 3h12a1 1 0 0 0 1-1V4Z"/><path d="M15 2v2"/><path d="M15 14v10"/></svg>,
        Compass: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>,
        Sparkles: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
        Volume2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>,
        X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
        Send: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
        Lightbulb: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="9" x2="15" y1="18" y2="18"/><line x1="10" x2="14" y1="22" y2="22"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 12 2a4.65 4.65 0 0 0-4.5 9.5c.76.76 1.23 1.52 1.41 2.5"/></svg>,
        Loader2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
    };

    // --- Data ---
    const JOURNEY_STAGES = [
      {
        id: 'lu-early',
        title: 'åˆä»•é­¯åœ‹ï¼šå¤§æ²»ä¹‹ä¸–',
        location: 'é­¯åœ‹ (Lu)',
        year: 'ç´„å…¬å…ƒå‰ 500 å¹´ (51æ­²)',
        icon: <Icons.Award className="w-8 h-8 text-gold" />,
        description: 'å­”å­åœ¨é­¯åœ‹ä»»ä¸­éƒ½å®°ï¼Œå¾Œå‡ä»»å¤§å¸å¯‡ï¼ˆæŒç®¡åˆ‘ç„ç³¾å¯Ÿï¼‰ã€‚ä»–æ¨è¡Œç¦®æ¨‚æ•™åŒ–ï¼Œé­¯åœ‹å¤§æ²»ï¼Œè·¯ä¸æ‹¾éºï¼Œå¤œä¸é–‰æˆ¶ã€‚é½Šåœ‹å› ææ‡¼é­¯åœ‹å¼·å¤§ï¼Œé€ç¾å¥³é§¿é¦¬çµ¦é­¯å®šå…¬ï¼Œå°è‡´å®šå…¬æ²ˆè¿·è²è‰²ï¼Œä¸ç†æœæ”¿ã€‚',
        philosophy: 'ã€Œé“ä¹‹ä»¥æ”¿ï¼Œé½Šä¹‹ä»¥åˆ‘ï¼Œæ°‘å…è€Œç„¡æ¥ï¼›é“ä¹‹ä»¥å¾·ï¼Œé½Šä¹‹ä»¥ç¦®ï¼Œæœ‰æ¥ä¸”æ ¼ã€‚ã€',
        philosophyMeaning: 'æ”¿æ²»ç†å¿µï¼šä¸»å¼µä»¥å¾·æ²»åœ‹ï¼Œè€Œéå–®ç´”ä¾é åˆ‘ç½°ã€‚',
        discussion: 'å¦‚æœä½ æ˜¯å­”å­ï¼Œçœ‹åˆ°åœ‹å›æ²ˆè¿·ç©æ¨‚ä¸å†ä¿¡ä»»ä½ ï¼Œä½ æœƒé¸æ“‡ç•™ä¸‹ä¾†ç¹¼çºŒå‹¸è««ï¼Œé‚„æ˜¯é›¢é–‹å°‹æ‰¾æ–°æ©Ÿæœƒï¼Ÿç‚ºä»€éº¼ï¼Ÿ',
        mapCoords: { x: 80, y: 30 }
      },
      {
        id: 'departure',
        title: 'è¢«è¿«å»è·ï¼šå‘¨éŠä¹‹å§‹',
        location: 'é›¢é–‹é­¯åœ‹',
        year: 'ç´„å…¬å…ƒå‰ 497 å¹´ (55æ­²)',
        icon: <Icons.Compass className="w-8 h-8 text-gray-500" />,
        description: 'å› é­¯å®šå…¬æ²ˆè¿·é½Šåœ‹é€ä¾†çš„å¥³æ¨‚ï¼Œä¸¦åœ¨éƒŠç¥­æ™‚é•èƒŒç¦®åˆ¶ï¼ˆä¸åˆ†é€ç¥­è‚‰çµ¦å¤§å¤«ï¼‰ï¼Œå­”å­æ·±æ„Ÿå¤±æœ›ï¼Œæ±ºå®šé›¢é–‹çˆ¶æ¯ä¹‹é‚¦ï¼Œé–‹å§‹äº†é•·é”åå››å¹´çš„å‘¨éŠåˆ—åœ‹ç”Ÿæ¶¯ï¼Œå°‹æ‰¾èƒ½å¯¦è¸ã€Œä»æ”¿ã€çš„å›ä¸»ã€‚',
        philosophy: 'ã€Œå£«å¿—æ–¼é“ï¼Œè€Œæ¥æƒ¡è¡£æƒ¡é£Ÿè€…ï¼Œæœªè¶³èˆ‡è­°ä¹Ÿã€‚ã€',
        philosophyMeaning: 'å¿ƒæ…‹å±•ç¾ï¼šè®€æ›¸äººç«‹å¿—æ–¼çœŸç†ï¼Œä¸æ‡‰ä»¥ç‰©è³ªç”Ÿæ´»çš„è²§ä¹ç‚ºæ¥ã€‚',
        discussion: 'å­”å­é›¢é–‹æ™‚å·²ç¶“50å¤šæ­²äº†ï¼Œç‚ºä»€éº¼ä»–é¡˜æ„æ”¾æ£„ç©©å®šçš„é«˜å®˜åšç¥¿ï¼Œå»é¢å°æœªçŸ¥çš„æµæµªç”Ÿæ´»ï¼Ÿ',
        mapCoords: { x: 70, y: 40 }
      },
      {
        id: 'wei',
        title: 'å±…è¡›æœŸé–“ï¼šéš›é‡æµ®æ²ˆ',
        location: 'è¡›åœ‹ (Wei)',
        year: 'å¤šæ¬¡é€²å‡ºè¡›åœ‹',
        icon: <Icons.Users className="w-8 h-8 text-indigo-700" />,
        description: 'è¡›éˆå…¬é›–ç„¶ç¦®é‡å­”å­ï¼Œçµ¦äºˆé«˜è–ªï¼Œä½†ä¸¦ä¸é‡ç”¨å…¶æ”¿æ²»ä¸»å¼µï¼Œä¸”è¡›åœ‹æ”¿æ²»æ··äº‚ï¼ˆå¦‚ã€Œå—å­ã€äº‹ä»¶ï¼‰ã€‚å­”å­æ„Ÿå˜†ã€Œå¾æœªè¦‹å¥½å¾·å¦‚å¥½è‰²è€…ä¹Ÿã€ï¼Œæ„è­˜åˆ°é€™è£¡ç„¡æ³•å¯¦è¸ç†æƒ³ã€‚',
        philosophy: 'ã€Œè‹Ÿæœ‰ç”¨æˆ‘è€…ï¼ŒæœŸæœˆè€Œå·²å¯ä¹Ÿï¼Œä¸‰å¹´æœ‰æˆã€‚ã€',
        philosophyMeaning: 'æ”¿æ²»è‡ªä¿¡ï¼šåªè¦æœ‰äººè‚¯é‡ç”¨æˆ‘ï¼Œä¸€å¹´å°±èƒ½çœ‹åˆ°æˆæ•ˆï¼Œä¸‰å¹´å°±èƒ½å¤§åŠŸå‘Šæˆã€‚å¯æƒœç„¡äººé‡ç”¨ã€‚',
        discussion: 'è¡›éˆå…¬çµ¦å­”å­å¾ˆé«˜çš„è–ªæ°´å»ä¸çµ¦å¯¦æ¬Šã€‚åœ¨ç¾ä»£è·å ´ä¸­ï¼Œä½ æœƒé¸æ“‡ã€Œé«˜è–ªä½†ç„¡å¯¦æ¬Šã€é‚„æ˜¯ã€Œä½è–ªä½†èƒ½ç™¼æ®ç†æƒ³ã€çš„å·¥ä½œï¼Ÿ',
        mapCoords: { x: 60, y: 20 }
      },
      {
        id: 'song',
        title: 'éå®‹ä¹‹å„ï¼šå¾®æœéå®‹',
        location: 'å®‹åœ‹ (Song)',
        year: 'å‘¨éŠé€”ä¸­',
        icon: <Icons.ShieldAlert className="w-8 h-8 text-seal-red" />,
        description: 'å­”å­ç¶“éå®‹åœ‹æ™‚ï¼Œåœ¨å¤§æ¨¹ä¸‹æ¼”ç¿’ç¦®å„€ã€‚å®‹åœ‹å¸é¦¬æ¡“é­‹ï¼ˆtuÃ­ï¼‰æƒ³æ®ºå­”å­ï¼ŒæŠŠå¤§æ¨¹ç å€’ã€‚å¼Ÿå­å€‘å‚¬ä¿ƒå­”å­å¿«è·‘ï¼Œå­”å­å»å±•ç¾äº†æ¥µé«˜çš„å®šåŠ›èˆ‡å¤©å‘½è§€ã€‚',
        philosophy: 'ã€Œå¤©ç”Ÿå¾·æ–¼äºˆï¼Œæ¡“é­‹å…¶å¦‚äºˆä½•ï¼Ÿã€',
        philosophyMeaning: 'å¤©å‘½è§€ï¼šä¸Šå¤©æŠŠå“å¾·è³¦äºˆäº†æˆ‘ï¼Œæ¡“é­‹èƒ½æŠŠæˆ‘æ€éº¼æ¨£å‘¢ï¼Ÿå±•ç¾è‡¨å±ä¸äº‚çš„å‹‡æ°£ã€‚',
        discussion: 'ç•¶ç”Ÿå‘½å—åˆ°å¨è„…æ™‚ï¼Œå­”å­ç‚ºä»€éº¼é‚„èƒ½é€™éº¼é®å®šï¼Ÿé€™ç¨®è‡ªä¿¡å¾ä½•è€Œä¾†ï¼Ÿ',
        mapCoords: { x: 50, y: 50 }
      },
      {
        id: 'chen-cai',
        title: 'é™³è”¡çµ•ç³§ï¼šå›°å¢ƒè€ƒé©—',
        location: 'é™³åœ‹èˆ‡è”¡åœ‹ä¹‹é–“',
        year: 'ç´„å…¬å…ƒå‰ 489 å¹´',
        icon: <Icons.ShieldAlert className="w-8 h-8 text-orange-700" />,
        description: 'å­”å­ä¸€è¡Œäººåœ¨é™³åœ‹å’Œè”¡åœ‹ä¹‹é–“è¢«è»éšŠåœå›°ï¼Œç³§é£Ÿæ–·çµ•ï¼Œè·Ÿéš¨çš„å¼Ÿå­è¨±å¤šéƒ½é¤“ç—…äº†ã€‚å­è·¯ç”Ÿæ°£åœ°å•ï¼šã€Œå›å­ä¹Ÿæœ‰çª®å›°çš„æ™‚å€™å—ï¼Ÿã€å­”å­ä»¥æ­¤æ•™å°å¼Ÿå­å›å­èˆ‡å°äººåœ¨é¢å°å›°å¢ƒæ™‚çš„å·®åˆ¥ã€‚',
        philosophy: 'ã€Œå›å­å›ºçª®ï¼Œå°äººçª®æ–¯æ¿«çŸ£ã€‚ã€',
        philosophyMeaning: 'é“å¾·ä¿®é¤Šï¼šå›å­åœ¨å›°çª˜æ™‚ä»èƒ½å …å®ˆç¯€æ“ï¼Œå°äººä¸€é‡åˆ°å›°çª˜å°±æœƒèƒ¡ä½œéç‚ºã€‚',
        discussion: 'é€™æ˜¯å­”å­æœ€è½é­„çš„æ™‚åˆ»ã€‚æ›ä½œæ˜¯ä¸€èˆ¬äººï¼Œåœ¨é¤“è‚šå­æ™‚å¯èƒ½å°±æœƒæ”¾æ£„åŸå‰‡ã€‚ä½ èªç‚ºæ˜¯ä»€éº¼åŠ›é‡æ”¯æ’è‘—ä»–å€‘ï¼Ÿ',
        mapCoords: { x: 40, y: 60 }
      },
      {
        id: 'return',
        title: 'æ™šå¹´æ­¸é­¯ï¼šåˆªè¿°å…­ç¶“',
        location: 'å›åˆ°é­¯åœ‹ (Lu)',
        year: 'ç´„å…¬å…ƒå‰ 484 å¹´ (68æ­²)',
        icon: <Icons.Scroll className="w-8 h-8 text-jade" />,
        description: 'åœ¨å­£åº·å­çš„é‚€è«‹ä¸‹ï¼Œ68æ­²çš„å­”å­çµ‚æ–¼å›åˆ°é­¯åœ‹ã€‚ä»–ä¸å†å°‹æ±‚ä»•é€”ï¼Œè€Œæ˜¯å°ˆæ³¨æ–¼æ•™è‚²èˆ‡æ•´ç†å¤ç±ã€‚ä»–åˆªè©©æ›¸ã€å®šç¦®æ¨‚ã€è´Šå‘¨æ˜“ã€ä½œæ˜¥ç§‹ï¼Œå¼Ÿå­å¤šé”ä¸‰åƒäººï¼Œèº«é€šå…­è—è€…ä¸ƒåäºŒäººï¼Œå°ä¸­è¯æ–‡åŒ–ç”¢ç”Ÿæ·±é å½±éŸ¿ã€‚',
        philosophy: 'ã€Œç™¼æ†¤å¿˜é£Ÿï¼Œæ¨‚ä»¥å¿˜æ†‚ï¼Œä¸çŸ¥è€ä¹‹å°‡è‡³äº‘çˆ¾ã€‚ã€',
        philosophyMeaning: 'çµ‚èº«å­¸ç¿’ï¼šå½¢å®¹è‡ªå·±å‹¤å¥®å­¸ç¿’åˆ°å¿˜è¨˜åƒé£¯ï¼Œå¿«æ¨‚åˆ°å¿˜è¨˜æ†‚æ„ï¼Œç”šè‡³ä¸çŸ¥é“è¡°è€å³å°‡åˆ°ä¾†ã€‚',
        discussion: 'å­”å­é›–ç„¶æ²’æœ‰åœ¨æ”¿æ²»ä¸Šå¯¦ç¾ç†æƒ³ï¼Œä½†ä»–åœ¨æ•™è‚²ä¸Šçš„æˆå°±å½±éŸ¿äº†å¾Œä¸–å…©åƒå¤šå¹´ã€‚é€™çµ¦æˆ‘å€‘å°æ–¼ã€ŒæˆåŠŸã€çš„å®šç¾©æœ‰ä»€éº¼å•Ÿç™¼ï¼Ÿ',
        mapCoords: { x: 80, y: 45 }
      }
    ];

    // --- API Helpers ---
    async function generateGeminiText(prompt, systemInstruction) {
      if(!apiKey) return "è«‹å…ˆé…ç½® API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ã€‚";
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
              systemInstruction: { parts: [{ text: systemInstruction }] }
            })
          }
        );
        
        if (!response.ok) throw new Error(`API call failed: ${response.status}`);
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨ç„¡æ³•å›ç­”ã€‚";
      } catch (e) {
        console.error(e);
        return "ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      }
    }

    async function generateGeminiSpeech(text) {
      if(!apiKey) return null;
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: text }] }],
              generationConfig: {
                responseModalities: ["AUDIO"],
                speechConfig: {
                  voiceConfig: {
                    prebuiltVoiceConfig: {
                      voiceName: "Orus"
                    }
                  }
                }
              }
            })
          }
        );

        if (!response.ok) throw new Error('TTS failed');
        const data = await response.json();
        const audioData = data.candidates[0].content.parts[0].inlineData.data;
        return audioData;
      } catch (e) {
        console.error(e);
        return null;
      }
    }

    function pcmToWav(base64PCM) {
      const binaryString = window.atob(base64PCM);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);

      const wavHeader = new ArrayBuffer(44);
      const view = new DataView(wavHeader);
      
      view.setUint8(0, 'R'.charCodeAt(0));
      view.setUint8(1, 'I'.charCodeAt(0));
      view.setUint8(2, 'F'.charCodeAt(0));
      view.setUint8(3, 'F'.charCodeAt(0));
      view.setUint32(4, 36 + len, true);
      view.setUint8(8, 'W'.charCodeAt(0));
      view.setUint8(9, 'A'.charCodeAt(0));
      view.setUint8(10, 'V'.charCodeAt(0));
      view.setUint8(11, 'E'.charCodeAt(0));
      
      view.setUint8(12, 'f'.charCodeAt(0));
      view.setUint8(13, 'm'.charCodeAt(0));
      view.setUint8(14, 't'.charCodeAt(0));
      view.setUint8(15, ' '.charCodeAt(0));
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true); 
      view.setUint16(22, 1, true); 
      view.setUint32(24, 24000, true); 
      view.setUint32(28, 24000 * 2, true); 
      view.setUint16(32, 2, true); 
      view.setUint16(34, 16, true); 
      
      view.setUint8(36, 'd'.charCodeAt(0));
      view.setUint8(37, 'a'.charCodeAt(0));
      view.setUint8(38, 't'.charCodeAt(0));
      view.setUint8(39, 'a'.charCodeAt(0));
      view.setUint32(40, len, true);

      const blob = new Blob([view, bytes], { type: 'audio/wav' });
      return URL.createObjectURL(blob);
    }

    // --- Main Component ---
    function ConfuciusJourneyApp() {
      const [currentStageIndex, setCurrentStageIndex] = useState(0);
      const [showDiscussion, setShowDiscussion] = useState(false);
      const [animateMap, setAnimateMap] = useState(false);

      // AI Features State
      const [isChatOpen, setIsChatOpen] = useState(false);
      const [chatMessage, setChatMessage] = useState('');
      const [chatHistory, setChatHistory] = useState([]);
      const [isChatLoading, setIsChatLoading] = useState(false);
      
      const [modernAnalogy, setModernAnalogy] = useState(null);
      const [isAnalogyLoading, setIsAnalogyLoading] = useState(false);
      
      const [isSpeaking, setIsSpeaking] = useState(false);
      const audioRef = useRef(null);
      const chatEndRef = useRef(null);

      const currentStage = JOURNEY_STAGES[currentStageIndex];
      const isFirst = currentStageIndex === 0;
      const isLast = currentStageIndex === JOURNEY_STAGES.length - 1;

      useEffect(() => {
        setAnimateMap(true);
        setModernAnalogy(null); 
        setChatHistory([]); 
        if(audioRef.current) {
            audioRef.current.pause();
            setIsSpeaking(false);
        }
        const timer = setTimeout(() => setAnimateMap(false), 1000);
        return () => clearTimeout(timer);
      }, [currentStageIndex]);

      useEffect(() => {
        if (chatEndRef.current) {
          chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
      }, [chatHistory, isChatOpen]);

      const handleNext = () => {
        if (!isLast) {
          setCurrentStageIndex(prev => prev + 1);
          setShowDiscussion(false);
        }
      };

      const handlePrev = () => {
        if (!isFirst) {
          setCurrentStageIndex(prev => prev - 1);
          setShowDiscussion(false);
        }
      };

      // AI Handlers
      const handleAskConfucius = async (e) => {
        e.preventDefault();
        if (!chatMessage.trim()) return;

        const userMsg = { role: 'user', text: chatMessage };
        setChatHistory(prev => [...prev, userMsg]);
        setChatMessage('');
        setIsChatLoading(true);

        const systemPrompt = `
          ä½ ç¾åœ¨æ‰®æ¼”å­”å­ï¼ˆå­”ä¸˜ï¼‰ã€‚
          è«‹æ³¨æ„ï¼Œä½ ç¾åœ¨æ­£è™•æ–¼äººç”Ÿçš„é€™å€‹éšæ®µï¼š${currentStage.title} - ${currentStage.description}ã€‚
          åœ°é»ï¼š${currentStage.location}ã€‚
          
          è«‹ç”¨ä¸€ä½å……æ»¿æ™ºæ…§ã€æ…ˆæ‚²ä½†å¶çˆ¾æœƒæ„Ÿå˜†ä¸–é“ä¸å…¬çš„é•·è€…èªæ°£å›ç­”å­¸ç”Ÿçš„å•é¡Œã€‚
          å¦‚æœå­¸ç”Ÿçš„å•é¡Œèˆ‡ä½ ç¾åœ¨çš„è™•å¢ƒç„¡é—œï¼Œè©¦è‘—ç”¨å„’å®¶çš„æ™ºæ…§å°‡å…¶é€£çµå›ä¾†ã€‚
          å›ç­”è¦ç°¡æ½”æœ‰åŠ›ï¼Œé©åˆèª²å ‚äº’å‹•ã€‚å¯ä»¥ä½¿ç”¨ã€Œå¾ã€è‡ªç¨±ã€‚
        `;

        const aiResponseText = await generateGeminiText(chatMessage, systemPrompt);
        
        setChatHistory(prev => [...prev, { role: 'ai', text: aiResponseText }]);
        setIsChatLoading(false);
      };

      const handleGenerateAnalogy = async () => {
        setIsAnalogyLoading(true);
        const systemPrompt = "ä½ æ˜¯ä¸€ä½æ“…é•·å°‡å¤ä»£å“²å­¸é€£çµåˆ°ç¾ä»£ç”Ÿæ´»çš„è€å¸«ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚";
        const prompt = `
          è«‹é‡å°å­”å­çš„é€™å¥åè¨€ï¼šã€Œ${currentStage.philosophy}ã€
          ï¼ˆå…¶å«ç¾©ç‚ºï¼š${currentStage.philosophyMeaning}ï¼‰
          
          ç”Ÿæˆä¸€å€‹ã€Œç¾ä»£ç”Ÿæ´»ã€æˆ–ã€Œè·å ´ã€çš„é¡æ¯”ï¼Œè®“ä¸­å­¸ç”Ÿèƒ½ç§’æ‡‚ã€‚
          è«‹ç”¨ä¸€å€‹ç°¡çŸ­çš„æ®µè½è§£é‡‹ï¼Œé–‹é ­ç”¨ã€Œâœ¨ ç¾ä»£è§£è®€ï¼šã€ã€‚
        `;
        
        const text = await generateGeminiText(prompt, systemPrompt);
        setModernAnalogy(text);
        setIsAnalogyLoading(false);
      };

      const handleSpeakQuote = async () => {
        if (isSpeaking) {
          if (audioRef.current) audioRef.current.pause();
          setIsSpeaking(false);
          return;
        }

        setIsSpeaking(true);
        const textToSpeak = `å­”å­æ›°ï¼š${currentStage.philosophy}`; 
        
        const pcmData = await generateGeminiSpeech(textToSpeak);
        if (pcmData) {
          const wavUrl = pcmToWav(pcmData);
          const audio = new Audio(wavUrl);
          audioRef.current = audio;
          audio.onended = () => setIsSpeaking(false);
          audio.play();
        } else {
          setIsSpeaking(false);
          if(!apiKey) alert("è«‹å…ˆé…ç½® API Key");
          else alert("èªéŸ³ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        }
      };


      return (
        <div className="min-h-screen bg-paper font-sans text-ink flex flex-col">
          {/* Header */}
          <header className="bg-ink text-paper p-4 sticky top-0 z-20 shadow-xl border-b border-gold/30">
            <div className="max-w-6xl mx-auto flex justify-between items-center">
              <div className="flex items-center space-x-3">
                <Icons.BookOpen className="w-6 h-6 text-gold" />
                <h1 className="text-xl md:text-2xl font-serif font-bold tracking-widest">è‡³è–å…ˆå¸«ï¼š<span className="text-gold">å­”å­</span>å‘¨éŠåˆ—åœ‹</h1>
              </div>
              <div className="flex items-center space-x-4">
                <div className="text-sm text-stone-400 hidden sm:block font-serif">
                  æ˜¥ç§‹ Â· ç¦®å´©æ¨‚å£ä¹‹éš›
                </div>
                <button 
                  onClick={() => setIsChatOpen(true)}
                  className="bg-gradient-to-r from-gold to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 transition-all shadow-md transform hover:scale-105 active:scale-95 border border-amber-300"
                >
                  <Icons.Sparkles className="w-4 h-4" />
                  å•å­”å­
                </button>
              </div>
            </div>
          </header>

          <main className="flex-grow max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8 w-full">
            
            {/* Left Column: Map & Navigation (4 cols) */}
            <div className="lg:col-span-4 flex flex-col space-y-6">
              
              {/* Map Visualization */}
              <div className="bg-white p-5 rounded-xl shadow-md border border-stone-200 relative overflow-hidden group">
                <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-stone-200 via-stone-400 to-stone-200 opacity-50"></div>
                
                <h3 className="text-stone-500 font-bold mb-4 flex items-center tracking-wider text-sm uppercase border-b border-stone-100 pb-2">
                  <Icons.MapPin className="w-4 h-4 mr-2 text-gold" /> 
                  æ˜¥ç§‹åˆ—åœ‹åœ–
                </h3>
                
                <div className="aspect-square bg-[#f3f1eb] rounded-lg relative border border-[#e5e2d6] shadow-inner">
                  {/* Subtle Grid Background */}
                  <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#444 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>

                  <svg viewBox="0 0 100 100" className="w-full h-full absolute top-0 left-0 pointer-events-none">
                    {/* Background Path */}
                    <path 
                      d="M 80 30 L 70 40 L 60 20 L 50 50 L 40 60 L 80 45" 
                      fill="none" stroke="#d6d3d1" strokeWidth="2" strokeDasharray="4"
                      className="opacity-50"
                    />
                    {/* Active Path with Animation */}
                    <path 
                      d={`M 80 30 ${currentStageIndex > 0 ? 'L 70 40' : ''} ${currentStageIndex > 1 ? 'L 60 20' : ''} ${currentStageIndex > 2 ? 'L 50 50' : ''} ${currentStageIndex > 3 ? 'L 40 60' : ''} ${currentStageIndex > 4 ? 'L 80 45' : ''}`}
                      fill="none" stroke="#b45309" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"
                      className="transition-all duration-1000 ease-in-out drop-shadow-md"
                    />
                    
                    {/* Nodes */}
                    {JOURNEY_STAGES.map((stage, idx) => (
                      <circle
                        key={stage.id} cx={stage.mapCoords.x} cy={stage.mapCoords.y}
                        r={currentStageIndex === idx ? 5 : 2.5}
                        fill={currentStageIndex === idx ? "#b91c1c" : "#78716c"}
                        stroke="#fff" strokeWidth="1.5"
                        className="transition-all duration-500"
                      />
                    ))}
                    
                    {/* Pulse Effect for current location */}
                    <circle cx={currentStage.mapCoords.x} cy={currentStage.mapCoords.y} r="8" stroke="#b91c1c" strokeWidth="1" fill="none" className="animate-ping opacity-75" />
                  </svg>

                  {/* Labels */}
                  {JOURNEY_STAGES.map((stage, idx) => (
                    <div 
                      key={stage.id}
                      className={`absolute transform -translate-x-1/2 -translate-y-1/2 text-[10px] md:text-xs font-serif font-bold transition-all duration-500 cursor-pointer
                        ${currentStageIndex === idx 
                          ? 'text-seal-red scale-110 z-10 bg-white/90 px-2 py-1 rounded shadow-md border border-stone-200' 
                          : 'text-stone-400 scale-90 hover:text-stone-600'}
                      `}
                      style={{ left: `${stage.mapCoords.x}%`, top: `${stage.mapCoords.y + 9}%` }}
                      onClick={() => { setCurrentStageIndex(idx); setShowDiscussion(false); }}
                    >
                      {stage.location.split(' ')[0]}
                    </div>
                  ))}
                </div>
              </div>

              {/* Progress List (Scroll-like) */}
              <div className="bg-white rounded-xl shadow-md border border-stone-200 p-6 hidden lg:block relative overflow-hidden">
                <div className="absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl from-stone-100 to-transparent rounded-tr-xl opacity-50"></div>
                <h3 className="text-stone-500 font-bold mb-4 font-serif">ç”Ÿå‘½æ­·ç¨‹</h3>
                <ul className="space-y-0 relative border-l-2 border-stone-100 ml-3">
                  {JOURNEY_STAGES.map((stage, idx) => (
                    <li key={stage.id} className="relative pl-6 py-2 group">
                      <div className={`absolute -left-[9px] top-4 w-4 h-4 rounded-full border-4 transition-colors duration-300 ${idx <= currentStageIndex ? 'bg-white border-gold' : 'bg-white border-stone-200 group-hover:border-stone-300'}`}></div>
                      <button 
                        onClick={() => { setCurrentStageIndex(idx); setShowDiscussion(false); }}
                        className={`text-left w-full transition-all duration-300
                          ${currentStageIndex === idx ? 'text-ink font-bold translate-x-1' : 'text-stone-500 hover:text-stone-700'}`}
                      >
                        <span className="block font-serif text-base">{stage.title}</span>
                        {currentStageIndex === idx && <span className="block text-xs text-gold mt-1 animate-fadeIn">{stage.year}</span>}
                      </button>
                    </li>
                  ))}
                </ul>
              </div>
            </div>

            {/* Center/Right Column: Main Content (8 cols) */}
            <div className="lg:col-span-8 flex flex-col">
              
              {/* Content Card */}
              <div className="bg-white rounded-xl shadow-lg border border-stone-200 flex-grow overflow-hidden flex flex-col relative">
                {/* Decorative Pattern Top Right */}
                <div className="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                    <svg width="100" height="100" viewBox="0 0 100 100" fill="none">
                        <path d="M50 0 C50 25 75 50 100 50 C75 50 50 75 50 100 C50 75 25 50 0 50 C25 50 50 25 50 0 Z" fill="#000"/>
                    </svg>
                </div>

                {/* Top Banner Area */}
                <div className="relative bg-ink h-40 flex items-center justify-center overflow-hidden">
                   <div className="absolute inset-0 opacity-30" style={{backgroundImage: 'url("https://www.transparenttextures.com/patterns/wood-pattern.png")'}}></div>
                   <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                   
                   <div className="relative z-10 text-center px-4">
                     <span className="inline-block px-3 py-1 bg-white/10 backdrop-blur-sm rounded border border-white/20 text-gold text-xs font-serif tracking-[0.2em] mb-3">
                        {currentStage.year}
                     </span>
                     <h2 className="text-3xl md:text-5xl font-serif font-bold text-white tracking-widest drop-shadow-lg">
                        {currentStage.title.split('ï¼š')[0]}
                     </h2>
                     <p className="text-stone-300 mt-2 text-sm md:text-base font-light tracking-wider">
                        {currentStage.title.split('ï¼š')[1]}
                     </p>
                   </div>
                </div>

                <div className="p-6 md:p-10 flex-grow flex flex-col space-y-8">
                  
                  {/* Location & Description */}
                  <div>
                    <div className="flex items-center space-x-4 mb-6">
                        <div className="p-3 bg-stone-50 rounded-full border border-stone-200 text-gold">
                            {currentStage.icon}
                        </div>
                        <div>
                            <div className="text-xs font-bold text-stone-400 uppercase tracking-wider">é§è¶³ä¹‹åœ°</div>
                            <div className="text-xl font-serif font-bold text-ink">{currentStage.location}</div>
                        </div>
                    </div>
                    
                    <div className="prose prose-stone max-w-none prose-lg text-justify text-stone-600 font-light">
                        <p>{currentStage.description}</p>
                    </div>
                  </div>

                  {/* Philosophy Section */}
                  <div className="relative bg-[#faf9f6] p-8 rounded-lg border border-stone-100 shadow-sm overflow-hidden group hover:shadow-md transition-shadow duration-300">
                    {/* Quote Mark Decoration */}
                    <div className="absolute top-4 left-4 text-9xl font-serif text-stone-200 opacity-30 select-none pointer-events-none">â€œ</div>
                    
                    <div className="relative z-10">
                        <div className="flex flex-col md:flex-row gap-6">
                            <div className="flex-grow">
                                <p className="text-2xl font-serif font-bold text-ink leading-relaxed mb-3 pl-2 border-l-4 border-seal-red">
                                    {currentStage.philosophy}
                                </p>
                                <p className="text-sm text-stone-500 mt-2">
                                    <span className="inline-block px-2 py-0.5 bg-stone-200 rounded text-stone-600 text-xs mr-2 font-bold">é‡‹ç¾©</span> 
                                    {currentStage.philosophyMeaning}
                                </p>
                            </div>
                        </div>

                        {/* AI Action Buttons */}
                        <div className="flex flex-wrap gap-3 mt-6 pt-6 border-t border-stone-200/60">
                            <button 
                                onClick={handleSpeakQuote}
                                className={`flex items-center text-xs font-medium px-4 py-2 rounded-md border transition-all duration-200
                                ${isSpeaking 
                                    ? 'bg-seal-red/10 text-seal-red border-seal-red/30' 
                                    : 'bg-white text-stone-600 border-stone-200 hover:border-gold hover:text-gold hover:bg-gold/5'}
                                `}
                            >
                                {isSpeaking ? <Icons.Loader2 className="w-3.5 h-3.5 mr-2 animate-spin" /> : <Icons.Volume2 className="w-3.5 h-3.5 mr-2" />}
                                {isSpeaking ? 'èª¦è®€ä¸­...' : 'è†è½è–è¨€'}
                            </button>

                            <button 
                                onClick={handleGenerateAnalogy}
                                disabled={isAnalogyLoading}
                                className="flex items-center text-xs font-medium px-4 py-2 rounded-md bg-white text-jade border border-stone-200 hover:bg-jade/5 hover:border-jade transition-colors"
                            >
                                {isAnalogyLoading ? <Icons.Loader2 className="w-3.5 h-3.5 mr-2 animate-spin" /> : <Icons.Lightbulb className="w-3.5 h-3.5 mr-2" />}
                                ç¾ä»£è·å ´è§£è®€
                            </button>
                        </div>

                        {/* Analogy Result */}
                        {modernAnalogy && (
                            <div className="mt-4 p-4 bg-white/60 border border-jade/20 rounded-lg text-sm text-jade/90 leading-relaxed animate-[fadeIn_0.5s_ease-out]">
                                {modernAnalogy}
                            </div>
                        )}
                    </div>
                  </div>

                  {/* Discussion Section */}
                  <div className="mt-auto">
                    <button 
                      onClick={() => setShowDiscussion(!showDiscussion)}
                      className="w-full group flex items-center justify-between p-4 bg-white hover:bg-stone-50 border border-stone-200 rounded-lg transition-all duration-200 shadow-sm"
                    >
                      <div className="flex items-center text-indigo-900 font-bold">
                          <div className="bg-indigo-100 p-2 rounded-full mr-3 group-hover:bg-indigo-200 transition-colors">
                            <Icons.MessageCircle className="w-5 h-5 text-indigo-700" />
                          </div>
                          {showDiscussion ? 'éš±è—æ€è€ƒé¡Œ' : 'é¡¯ç¤ºèª²å ‚æ€è€ƒé¡Œ (æ•™å¸«ç”¨)'}
                      </div>
                      <div className="text-stone-400">
                          {showDiscussion ? <Icons.ChevronLeft className="w-5 h-5 rotate-90" /> : <Icons.ChevronRight className="w-5 h-5 rotate-90" />}
                      </div>
                    </button>

                    {showDiscussion && (
                      <div className="mt-2 p-6 bg-indigo-900 text-indigo-50 rounded-lg shadow-inner animate-[slideDown_0.3s_ease-out] relative overflow-hidden">
                        <div className="absolute top-0 right-0 -mt-2 -mr-2 w-20 h-20 bg-indigo-500 rounded-full opacity-20 blur-xl"></div>
                        <h4 className="font-bold text-indigo-300 mb-2 text-xs uppercase tracking-widest flex items-center">
                            <span className="w-2 h-2 bg-indigo-400 rounded-full mr-2"></span> æ·±åº¦æ€è¾¨
                        </h4>
                        <p className="text-lg font-medium leading-relaxed font-serif">
                          {currentStage.discussion}
                        </p>
                      </div>
                    )}
                  </div>
                </div>

                {/* Footer Nav */}
                <div className="bg-stone-50 p-4 border-t border-stone-200 flex justify-between items-center">
                  <button 
                    onClick={handlePrev}
                    disabled={isFirst}
                    className={`flex items-center space-x-2 px-5 py-2.5 rounded-lg font-bold transition-all
                      ${isFirst 
                        ? 'text-stone-300 cursor-not-allowed opacity-50' 
                        : 'bg-white text-stone-700 hover:text-gold hover:border-gold border border-stone-200 shadow-sm hover:shadow'}`}
                  >
                    <Icons.ChevronLeft className="w-4 h-4" />
                    <span>ä¸Šä¸€ç« </span>
                  </button>

                  <div className="flex space-x-1">
                    {JOURNEY_STAGES.map((_, i) => (
                        <div key={i} className={`h-1.5 rounded-full transition-all duration-300 ${i === currentStageIndex ? 'w-8 bg-gold' : 'w-2 bg-stone-300'}`}></div>
                    ))}
                  </div>

                  <button 
                    onClick={handleNext}
                    disabled={isLast}
                    className={`flex items-center space-x-2 px-5 py-2.5 rounded-lg font-bold transition-all
                      ${isLast 
                        ? 'text-stone-300 cursor-not-allowed opacity-50' 
                        : 'bg-ink text-white hover:bg-stone-800 shadow-md hover:shadow-lg border border-transparent'}`}
                  >
                    <span>ä¸‹ä¸€ç« </span>
                    <Icons.ChevronRight className="w-4 h-4" />
                  </button>
                </div>
              </div>
            </div>
          </main>

          {/* Chat Modal */}
          {isChatOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-ink/60 backdrop-blur-sm transition-opacity duration-300">
              <div className="bg-paper rounded-2xl shadow-2xl w-full max-w-md h-[80vh] max-h-[700px] flex flex-col overflow-hidden animate-[zoomIn_0.2s_ease-out] border border-stone-300 relative">
                
                {/* Chat Header */}
                <div className="bg-ink text-paper p-4 flex justify-between items-center relative overflow-hidden">
                  <div className="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')]"></div>
                  <div className="flex items-center gap-3 relative z-10">
                    <div className="p-2 bg-white/10 rounded-full border border-white/10">
                      <Icons.Sparkles className="w-5 h-5 text-gold" />
                    </div>
                    <div>
                      <h3 className="font-bold font-serif text-lg tracking-wide">å•å­”å­</h3>
                      <p className="text-xs text-stone-400 flex items-center gap-1">
                        <span className="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                        ç•¶å‰ï¼š{currentStage.location.split(' ')[0]}
                      </p>
                    </div>
                  </div>
                  <button onClick={() => setIsChatOpen(false)} className="text-stone-400 hover:text-white transition-colors relative z-10 p-2 hover:bg-white/10 rounded-full">
                    <Icons.X className="w-6 h-6" />
                  </button>
                </div>

                {/* Chat Messages */}
                <div className="flex-1 overflow-y-auto p-5 space-y-5 bg-stone-100/50">
                  {chatHistory.length === 0 && (
                    <div className="text-center py-12 text-stone-400 px-6 flex flex-col items-center">
                      <div className="w-16 h-16 bg-stone-200 rounded-full flex items-center justify-center mb-4 text-3xl shadow-inner">
                        ğŸ“œ
                      </div>
                      <p className="font-serif text-lg text-ink mb-2">å¾ä¹ƒå­”ä¸˜ã€‚</p>
                      <p className="text-sm">æ±æœ‰ä½•æƒ‘ï¼Ÿé¡˜èå…¶è©³ã€‚</p>
                      <p className="text-xs mt-6 text-stone-400 bg-stone-200/50 px-3 py-1 rounded-full">( è«‹æ ¹æ“š {currentStage.location} æ™‚æœŸæå• )</p>
                    </div>
                  )}
                  {chatHistory.map((msg, i) => (
                    <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-[fadeIn_0.3s_ease-out]`}>
                      <div className={`flex flex-col max-w-[85%] ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                          <span className="text-[10px] text-stone-400 mb-1 px-1">{msg.role === 'user' ? 'ä½ ' : 'å­”å­'}</span>
                          <div 
                            className={`p-3.5 rounded-2xl text-sm shadow-sm leading-relaxed
                              ${msg.role === 'user' 
                                ? 'bg-gradient-to-br from-stone-700 to-stone-800 text-white rounded-tr-sm' 
                                : 'bg-white text-stone-800 border border-stone-200 rounded-tl-sm font-serif'
                              }`}
                          >
                            {msg.text}
                          </div>
                      </div>
                    </div>
                  ))}
                  {isChatLoading && (
                    <div className="flex justify-start animate-pulse">
                      <div className="bg-white px-4 py-3 rounded-2xl rounded-tl-sm shadow-sm border border-stone-200 flex items-center gap-2 text-stone-500 text-sm">
                        <Icons.Loader2 className="w-4 h-4 animate-spin text-gold" /> 
                        <span className="font-serif">å¤«å­æ²ˆæ€ä¸­...</span>
                      </div>
                    </div>
                  )}
                  <div ref={chatEndRef} />
                </div>

                {/* Chat Input */}
                <form onSubmit={handleAskConfucius} className="p-4 bg-white border-t border-stone-200">
                  <div className="flex gap-2 relative">
                    <input 
                      type="text" 
                      value={chatMessage}
                      onChange={(e) => setChatMessage(e.target.value)}
                      placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..."
                      className="flex-1 px-5 py-3 bg-stone-50 rounded-full focus:outline-none focus:ring-2 focus:ring-gold/50 focus:bg-white border border-stone-200 text-sm transition-all"
                    />
                    <button 
                      type="submit"
                      disabled={isChatLoading || !chatMessage.trim()}
                      className="p-3 bg-ink text-gold rounded-full hover:bg-stone-800 hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md"
                    >
                      <Icons.Send className="w-5 h-5" />
                    </button>
                  </div>
                  <div className="text-center mt-2">
                    <p className="text-[10px] text-stone-300">ç”± Gemini AI é©…å‹•ç”Ÿæˆ</p>
                  </div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ConfuciusJourneyApp />);
</script>

</body>
</html>
