<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡³è–å…ˆå¸«ï¼šå­”å­å‘¨éŠåˆ—åœ‹äº’å‹•åœ–</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        'paper': '#fdfbf7', // å®£ç´™ç™½
                        'ink': '#1c1917',   // å¾½å¢¨é»‘
                        'seal-red': '#b91c1c', // ç¡ƒç ‚ç´…
                        'jade': '#376e6f',    // ç‰çŸ³ç¶ 
                        'gold': '#d97706',    // ç‰ç’ƒé‡‘
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #fdfbf7;
            /* è¼•å¾®çš„ç´™å¼µç´‹ç† */
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .animate-slow-pulse {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="text-ink font-sans antialiased selection:bg-gold selection:text-white">

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- Gemini API Configuration ---
    // è‹¥éœ€ä½¿ç”¨ AI åŠŸèƒ½ï¼Œè«‹åœ¨æ­¤å¡«å…¥ API Keyï¼Œå¦å‰‡åƒ…é¡¯ç¤ºéœæ…‹å…§å®¹
    const apiKey = ""; 

    // --- SVG Icons (æ›¿æ› lucide-react ä»¥ç¢ºä¿å–®æª”é‹è¡Œ) ---
    const Icons = {
        MapPin: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
        BookOpen: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
        ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
        ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
        MessageCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
        Award: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>,
        Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
        ShieldAlert: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
        Scroll: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 4c0-1.1-.9-2-2-2H6a2 2 0 0 0-2 2v15a3 3 0 0 0 3 3h12a1 1 0 0 0 1-1V4Z"/><path d="M15 2v2"/><path d="M15 14v10"/></svg>,
        Compass: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>,
        Sparkles: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
        Volume2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>,
        X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
        Send: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
        Lightbulb: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="9" x2="15" y1="18" y2="18"/><line x1="10" x2="14" y1="22" y2="22"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 12 2a4.65 4.65 0 0 0-4.5 9.5c.76.76 1.23 1.52 1.41 2.5"/></svg>,
        Loader2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
    };

    // --- è³‡æ–™ï¼šå­”å­ç”Ÿå¹³ ---
    const JOURNEY_STAGES = [
      {
        id: 'lu-early',
        title: 'åˆä»•é­¯åœ‹ï¼šå¤§æ²»ä¹‹ä¸–',
        location: 'é­¯åœ‹ (Lu)',
        year: 'ç´„å…¬å…ƒå‰ 500 å¹´ (51æ­²)',
        icon: <Icons.Award className="w-8 h-8 text-gold" />,
        description: 'å­”å­åœ¨é­¯åœ‹ä»»ä¸­éƒ½å®°ï¼Œå¾Œå‡ä»»å¤§å¸å¯‡ï¼ˆæŒç®¡åˆ‘ç„ç³¾å¯Ÿï¼‰ã€‚ä»–æ¨è¡Œç¦®æ¨‚æ•™åŒ–ï¼Œé­¯åœ‹å¤§æ²»ï¼Œè·¯ä¸æ‹¾éºï¼Œå¤œä¸é–‰æˆ¶ã€‚é½Šåœ‹å› ææ‡¼é­¯åœ‹å¼·å¤§ï¼Œé€ç¾å¥³é§¿é¦¬çµ¦é­¯å®šå…¬ï¼Œå°è‡´å®šå…¬æ²ˆè¿·è²è‰²ï¼Œä¸ç†æœæ”¿ã€‚',
        philosophy: 'ã€Œé“ä¹‹ä»¥æ”¿ï¼Œé½Šä¹‹ä»¥åˆ‘ï¼Œæ°‘å…è€Œç„¡æ¥ï¼›é“ä¹‹ä»¥å¾·ï¼Œé½Šä¹‹ä»¥ç¦®ï¼Œæœ‰æ¥ä¸”æ ¼ã€‚ã€',
        philosophyMeaning: 'æ”¿æ²»ç†å¿µï¼šä¸»å¼µä»¥å¾·æ²»åœ‹ï¼Œè€Œéå–®ç´”ä¾é åˆ‘ç½°ã€‚',
        discussion: 'å¦‚æœä½ æ˜¯å­”å­ï¼Œçœ‹åˆ°åœ‹å›æ²ˆè¿·ç©æ¨‚ä¸å†ä¿¡ä»»ä½ ï¼Œä½ æœƒé¸æ“‡ç•™ä¸‹ä¾†ç¹¼çºŒå‹¸è««ï¼Œé‚„æ˜¯é›¢é–‹å°‹æ‰¾æ–°æ©Ÿæœƒï¼Ÿç‚ºä»€éº¼ï¼Ÿ',
        mapCoords: { x: 80, y: 30 }
      },
      {
        id: 'departure',
        title: 'è¢«è¿«å»è·ï¼šå‘¨éŠä¹‹å§‹',
        location: 'é›¢é–‹é­¯åœ‹',
        year: 'ç´„å…¬å…ƒå‰ 497 å¹´ (55æ­²)',
        icon: <Icons.Compass className="w-8 h-8 text-stone-500" />,
        description: 'å› é­¯å®šå…¬æ²ˆè¿·é½Šåœ‹é€ä¾†çš„å¥³æ¨‚ï¼Œä¸¦åœ¨éƒŠç¥­æ™‚é•èƒŒç¦®åˆ¶ï¼ˆä¸åˆ†é€ç¥­è‚‰çµ¦å¤§å¤«ï¼‰ï¼Œå­”å­æ·±æ„Ÿå¤±æœ›ï¼Œæ±ºå®šé›¢é–‹çˆ¶æ¯ä¹‹é‚¦ï¼Œé–‹å§‹äº†é•·é”åå››å¹´çš„å‘¨éŠåˆ—åœ‹ç”Ÿæ¶¯ï¼Œå°‹æ‰¾èƒ½å¯¦è¸ã€Œä»æ”¿ã€çš„å›ä¸»ã€‚',
        philosophy: 'ã€Œå£«å¿—æ–¼é“ï¼Œè€Œæ¥æƒ¡è¡£æƒ¡é£Ÿè€…ï¼Œæœªè¶³èˆ‡è­°ä¹Ÿã€‚ã€',
        philosophyMeaning: 'å¿ƒæ…‹å±•ç¾ï¼šè®€æ›¸äººç«‹å¿—æ–¼çœŸç†ï¼Œä¸æ‡‰ä»¥ç‰©è³ªç”Ÿæ´»çš„è²§ä¹ç‚ºæ¥ã€‚',
        discussion: 'å­”å­é›¢é–‹æ™‚å·²ç¶“50å¤šæ­²äº†ï¼Œç‚ºä»€éº¼ä»–é¡˜æ„æ”¾æ£„ç©©å®šçš„é«˜å®˜åšç¥¿ï¼Œå»é¢å°æœªçŸ¥çš„æµæµªç”Ÿæ´»ï¼Ÿ',
        mapCoords: { x: 70, y: 40 }
      },
      {
        id: 'wei',
        title: 'å±…è¡›æœŸé–“ï¼šéš›é‡æµ®æ²ˆ',
        location: 'è¡›åœ‹ (Wei)',
        year: 'å¤šæ¬¡é€²å‡ºè¡›åœ‹',
        icon: <Icons.Users className="w-8 h-8 text-indigo-700" />,
        description: 'è¡›éˆå…¬é›–ç„¶ç¦®é‡å­”å­ï¼Œçµ¦äºˆé«˜è–ªï¼Œä½†ä¸¦ä¸é‡ç”¨å…¶æ”¿æ²»ä¸»å¼µï¼Œä¸”è¡›åœ‹æ”¿æ²»æ··äº‚ï¼ˆå¦‚ã€Œå—å­ã€äº‹ä»¶ï¼‰ã€‚å­”å­æ„Ÿå˜†ã€Œå¾æœªè¦‹å¥½å¾·å¦‚å¥½è‰²è€…ä¹Ÿã€ï¼Œæ„è­˜åˆ°é€™è£¡ç„¡æ³•å¯¦è¸ç†æƒ³ã€‚',
        philosophy: 'ã€Œè‹Ÿæœ‰ç”¨æˆ‘è€…ï¼ŒæœŸæœˆè€Œå·²å¯ä¹Ÿï¼Œä¸‰å¹´æœ‰æˆã€‚ã€',
        philosophyMeaning: 'æ”¿æ²»è‡ªä¿¡ï¼šåªè¦æœ‰äººè‚¯é‡ç”¨æˆ‘ï¼Œä¸€å¹´å°±èƒ½çœ‹åˆ°æˆæ•ˆï¼Œä¸‰å¹´å°±èƒ½å¤§åŠŸå‘Šæˆã€‚å¯æƒœç„¡äººé‡ç”¨ã€‚',
        discussion: 'è¡›éˆå…¬çµ¦å­”å­å¾ˆé«˜çš„è–ªæ°´å»ä¸çµ¦å¯¦æ¬Šã€‚åœ¨ç¾ä»£è·å ´ä¸­ï¼Œä½ æœƒé¸æ“‡ã€Œé«˜è–ªä½†ç„¡å¯¦æ¬Šã€é‚„æ˜¯ã€Œä½è–ªä½†èƒ½ç™¼æ®ç†æƒ³ã€çš„å·¥ä½œï¼Ÿ',
        mapCoords: { x: 60, y: 20 }
      },
      {
        id: 'song',
        title: 'éå®‹ä¹‹å„ï¼šå¾®æœéå®‹',
        location: 'å®‹åœ‹ (Song)',
        year: 'å‘¨éŠé€”ä¸­',
        icon: <Icons.ShieldAlert className="w-8 h-8 text-seal-red" />,
        description: 'å­”å­ç¶“éå®‹åœ‹æ™‚ï¼Œåœ¨å¤§æ¨¹ä¸‹æ¼”ç¿’ç¦®å„€ã€‚å®‹åœ‹å¸é¦¬æ¡“é­‹ï¼ˆtuÃ­ï¼‰æƒ³æ®ºå­”å­ï¼ŒæŠŠå¤§æ¨¹ç å€’ã€‚å¼Ÿå­å€‘å‚¬ä¿ƒå­”å­å¿«è·‘ï¼Œå­”å­å»å±•ç¾äº†æ¥µé«˜çš„å®šåŠ›èˆ‡å¤©å‘½è§€ã€‚',
        philosophy: 'ã€Œå¤©ç”Ÿå¾·æ–¼äºˆï¼Œæ¡“é­‹å…¶å¦‚äºˆä½•ï¼Ÿã€',
        philosophyMeaning: 'å¤©å‘½è§€ï¼šä¸Šå¤©æŠŠå“å¾·è³¦äºˆäº†æˆ‘ï¼Œæ¡“é­‹èƒ½æŠŠæˆ‘æ€éº¼æ¨£å‘¢ï¼Ÿå±•ç¾è‡¨å±ä¸äº‚çš„å‹‡æ°£ã€‚',
        discussion: 'ç•¶ç”Ÿå‘½å—åˆ°å¨è„…æ™‚ï¼Œå­”å­ç‚ºä»€éº¼é‚„èƒ½é€™éº¼é®å®šï¼Ÿé€™ç¨®è‡ªä¿¡å¾ä½•è€Œä¾†ï¼Ÿ',
        mapCoords: { x: 50, y: 50 }
      },
      {
        id: 'chen-cai',
        title: 'é™³è”¡çµ•ç³§ï¼šå›°å¢ƒè€ƒé©—',
        location: 'é™³åœ‹èˆ‡è”¡åœ‹ä¹‹é–“',
        year: 'ç´„å…¬å…ƒå‰ 489 å¹´',
        icon: <Icons.ShieldAlert className="w-8 h-8 text-orange-700" />,
        description: 'å­”å­ä¸€è¡Œäººåœ¨é™³åœ‹å’Œè”¡åœ‹ä¹‹é–“è¢«è»éšŠåœå›°ï¼Œç³§é£Ÿæ–·çµ•ï¼Œè·Ÿéš¨çš„å¼Ÿå­è¨±å¤šéƒ½é¤“ç—…äº†ã€‚å­è·¯ç”Ÿæ°£åœ°å•ï¼šã€Œå›å­ä¹Ÿæœ‰çª®å›°çš„æ™‚å€™å—ï¼Ÿã€å­”å­ä»¥æ­¤æ•™å°å¼Ÿå­å›å­èˆ‡å°äººåœ¨é¢å°å›°å¢ƒæ™‚çš„å·®åˆ¥ã€‚',
        philosophy: 'ã€Œå›å­å›ºçª®ï¼Œå°äººçª®æ–¯æ¿«çŸ£ã€‚ã€',
        philosophyMeaning: 'é“å¾·ä¿®é¤Šï¼šå›å­åœ¨å›°çª˜æ™‚ä»èƒ½å …å®ˆç¯€æ“ï¼Œå°äººä¸€é‡åˆ°å›°çª˜å°±æœƒèƒ¡ä½œéç‚ºã€‚',
        discussion: 'é€™æ˜¯å­”å­æœ€è½é­„çš„æ™‚åˆ»ã€‚æ›ä½œæ˜¯ä¸€èˆ¬äººï¼Œåœ¨é¤“è‚šå­æ™‚å¯èƒ½å°±æœƒæ”¾æ£„åŸå‰‡ã€‚ä½ èªç‚ºæ˜¯ä»€éº¼åŠ›é‡æ”¯æ’è‘—ä»–å€‘ï¼Ÿ',
        mapCoords: { x: 40, y: 60 }
      },
      {
        id: 'return',
        title: 'æ™šå¹´æ­¸é­¯ï¼šåˆªè¿°å…­ç¶“',
        location: 'å›åˆ°é­¯åœ‹ (Lu)',
        year: 'ç´„å…¬å…ƒå‰ 484 å¹´ (68æ­²)',
        icon: <Icons.Scroll className="w-8 h-8 text-jade" />,
        description: 'åœ¨å­£åº·å­çš„é‚€è«‹ä¸‹ï¼Œ68æ­²çš„å­”å­çµ‚æ–¼å›åˆ°é­¯åœ‹ã€‚ä»–ä¸å†å°‹æ±‚ä»•é€”ï¼Œè€Œæ˜¯å°ˆæ³¨æ–¼æ•™è‚²èˆ‡æ•´ç†å¤ç±ã€‚ä»–åˆªè©©æ›¸ã€å®šç¦®æ¨‚ã€è´Šå‘¨æ˜“ã€ä½œæ˜¥ç§‹ï¼Œå¼Ÿå­å¤šé”ä¸‰åƒäººï¼Œèº«é€šå…­è—è€…ä¸ƒåäºŒäººï¼Œå°ä¸­è¯æ–‡åŒ–ç”¢ç”Ÿæ·±é å½±éŸ¿ã€‚',
        philosophy: 'ã€Œç™¼æ†¤å¿˜é£Ÿï¼Œæ¨‚ä»¥å¿˜æ†‚ï¼Œä¸çŸ¥è€ä¹‹å°‡è‡³äº‘çˆ¾ã€‚ã€',
        philosophyMeaning: 'çµ‚èº«å­¸ç¿’ï¼šå½¢å®¹è‡ªå·±å‹¤å¥®å­¸ç¿’åˆ°å¿˜è¨˜åƒé£¯ï¼Œå¿«æ¨‚åˆ°å¿˜è¨˜æ†‚æ„ï¼Œç”šè‡³ä¸çŸ¥é“è¡°è€å³å°‡åˆ°ä¾†ã€‚',
        discussion: 'å­”å­é›–ç„¶æ²’æœ‰åœ¨æ”¿æ²»ä¸Šå¯¦ç¾ç†æƒ³ï¼Œä½†ä»–åœ¨æ•™è‚²ä¸Šçš„æˆå°±å½±éŸ¿äº†å¾Œä¸–å…©åƒå¤šå¹´ã€‚é€™çµ¦æˆ‘å€‘å°æ–¼ã€ŒæˆåŠŸã€çš„å®šç¾©æœ‰ä»€éº¼å•Ÿç™¼ï¼Ÿ',
        mapCoords: { x: 80, y: 45 }
      }
    ];

    // --- API Functions (ä¿æŒåŸæœ‰é‚è¼¯) ---
    async function generateGeminiText(prompt, systemInstruction) {
      if(!apiKey) return "è«‹å…ˆåœ¨ä»£ç¢¼ä¸­å¡«å…¥æ‚¨çš„ API Key æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚";
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
              systemInstruction: { parts: [{ text: systemInstruction }] }
            })
          }
        );
        if (!response.ok) throw new Error(`API call failed: ${response.status}`);
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨ç„¡æ³•å›ç­”ã€‚";
      } catch (e) {
        console.error(e);
        return "ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      }
    }

    async function generateGeminiSpeech(text) {
      if(!apiKey) return null;
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: text }] }],
              generationConfig: {
                responseModalities: ["AUDIO"],
                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Orus" } } }
              }
            })
          }
        );
        if (!response.ok) throw new Error('TTS failed');
        const data = await response.json();
        return data.candidates[0].content.parts[0].inlineData.data;
      } catch (e) {
        console.error(e);
        return null;
      }
    }

    function pcmToWav(base64PCM) {
      // ç°¡å–®çš„ WAV è½‰æ›é‚è¼¯
      const binaryString = window.atob(base64PCM);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
      const wavHeader = new ArrayBuffer(44);
      const view = new DataView(wavHeader);
      view.setUint8(0, 'R'.charCodeAt(0)); view.setUint8(1, 'I'.charCodeAt(0)); view.setUint8(2, 'F'.charCodeAt(0)); view.setUint8(3, 'F'.charCodeAt(0));
      view.setUint32(4, 36 + len, true);
      view.setUint8(8, 'W'.charCodeAt(0)); view.setUint8(9, 'A'.charCodeAt(0)); view.setUint8(10, 'V'.charCodeAt(0)); view.setUint8(11, 'E'.charCodeAt(0));
      view.setUint8(12, 'f'.charCodeAt(0)); view.setUint8(13, 'm'.charCodeAt(0)); view.setUint8(14, 't'.charCodeAt(0)); view.setUint8(15, ' '.charCodeAt(0));
      view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, 24000, true); view.setUint32(28, 24000 * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
      view.setUint8(36, 'd'.charCodeAt(0)); view.setUint8(37, 'a'.charCodeAt(0)); view.setUint8(38, 't'.charCodeAt(0)); view.setUint8(39, 'a'.charCodeAt(0));
      view.setUint32(40, len, true);
      const blob = new Blob([view, bytes], { type: 'audio/wav' });
      return URL.createObjectURL(blob);
    }

    // --- ä¸»ç¨‹å¼å…ƒä»¶ ---
    function ConfuciusJourneyApp() {
      const [currentStageIndex, setCurrentStageIndex] = useState(0);
      const [showDiscussion, setShowDiscussion] = useState(false);
      
      // AI ç‹€æ…‹
      const [isChatOpen, setIsChatOpen] = useState(false);
      const [chatMessage, setChatMessage] = useState('');
      const [chatHistory, setChatHistory] = useState([]);
      const [isChatLoading, setIsChatLoading] = useState(false);
      const [modernAnalogy, setModernAnalogy] = useState(null);
      const [isAnalogyLoading, setIsAnalogyLoading] = useState(false);
      const [isSpeaking, setIsSpeaking] = useState(false);
      const audioRef = useRef(null);
      const chatEndRef = useRef(null);

      const currentStage = JOURNEY_STAGES[currentStageIndex];
      const isFirst = currentStageIndex === 0;
      const isLast = currentStageIndex === JOURNEY_STAGES.length - 1;

      useEffect(() => {
        setModernAnalogy(null); 
        setChatHistory([]); 
        if(audioRef.current) {
            audioRef.current.pause();
            setIsSpeaking(false);
        }
      }, [currentStageIndex]);

      useEffect(() => {
        if (chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
      }, [chatHistory, isChatOpen]);

      const handleNext = () => { if (!isLast) { setCurrentStageIndex(prev => prev + 1); setShowDiscussion(false); } };
      const handlePrev = () => { if (!isFirst) { setCurrentStageIndex(prev => prev - 1); setShowDiscussion(false); } };

      const handleAskConfucius = async (e) => {
        e.preventDefault();
        if (!chatMessage.trim()) return;
        const userMsg = { role: 'user', text: chatMessage };
        setChatHistory(prev => [...prev, userMsg]);
        setChatMessage('');
        setIsChatLoading(true);

        const systemPrompt = `ä½ ç¾åœ¨æ‰®æ¼”å­”å­ï¼ˆå­”ä¸˜ï¼‰ï¼Œè™•æ–¼äººç”Ÿéšæ®µï¼š${currentStage.title}ã€‚åœ°é»ï¼š${currentStage.location}ã€‚è«‹ç”¨å……æ»¿æ™ºæ…§ã€æ…ˆæ‚²çš„å¤æ–‡é¢¨å›ç­”ï¼Œå¯è‡ªç¨±ã€Œå¾ã€ã€‚`;
        const aiResponseText = await generateGeminiText(chatMessage, systemPrompt);
        
        setChatHistory(prev => [...prev, { role: 'ai', text: aiResponseText }]);
        setIsChatLoading(false);
      };

      const handleGenerateAnalogy = async () => {
        setIsAnalogyLoading(true);
        const prompt = `é‡å°å­”å­åè¨€ï¼šã€Œ${currentStage.philosophy}ã€å«ç¾©ï¼š${currentStage.philosophyMeaning}ã€‚ç”Ÿæˆä¸€å€‹ç¾ä»£ç”Ÿæ´»æˆ–è·å ´çš„é¡æ¯”ï¼Œè®“ä¸­å­¸ç”Ÿèƒ½ç§’æ‡‚ã€‚é–‹é ­ç”¨ã€Œâœ¨ ç¾ä»£è§£è®€ï¼šã€ã€‚`;
        const text = await generateGeminiText(prompt, "ä½ æ˜¯ä¸€ä½æ“…é•·å°‡å¤ä»£å“²å­¸é€£çµåˆ°ç¾ä»£ç”Ÿæ´»çš„è€å¸«ã€‚");
        setModernAnalogy(text);
        setIsAnalogyLoading(false);
      };

      const handleSpeakQuote = async () => {
        if (isSpeaking) {
          if (audioRef.current) audioRef.current.pause();
          setIsSpeaking(false);
          return;
        }
        setIsSpeaking(true);
        const pcmData = await generateGeminiSpeech(`å­”å­æ›°ï¼š${currentStage.philosophy}`);
        if (pcmData) {
          const audio = new Audio(pcmToWav(pcmData));
          audioRef.current = audio;
          audio.onended = () => setIsSpeaking(false);
          audio.play();
        } else {
          setIsSpeaking(false);
          alert("è«‹å…ˆé…ç½® API Key æˆ–ç¨å¾Œå†è©¦ã€‚");
        }
      };

      return (
        <div className="min-h-screen bg-paper font-sans text-ink flex flex-col">
          
          {/* é ‚éƒ¨å°èˆª */}
          <header className="bg-ink text-paper p-4 sticky top-0 z-20 shadow-xl border-b-2 border-gold">
            <div className="max-w-6xl mx-auto flex justify-between items-center">
              <div className="flex items-center space-x-3">
                <Icons.BookOpen className="w-6 h-6 text-gold" />
                <h1 className="text-xl md:text-2xl font-serif font-bold tracking-[0.1em]">è‡³è–å…ˆå¸«ï¼š<span className="text-gold">å­”å­</span>å‘¨éŠåˆ—åœ‹</h1>
              </div>
              <button 
                onClick={() => setIsChatOpen(true)}
                className="bg-gradient-to-r from-gold to-amber-700 hover:brightness-110 text-white px-5 py-2 rounded-full text-sm font-bold flex items-center gap-2 transition-all shadow-md transform hover:scale-105 active:scale-95 border border-amber-300/50"
              >
                <Icons.Sparkles className="w-4 h-4" />
                å•å­”å­
              </button>
            </div>
          </header>

          <main className="flex-grow max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8 w-full">
            
            {/* å·¦å´ï¼šåœ°åœ–èˆ‡å°èˆª (4æ¬„) */}
            <div className="lg:col-span-4 flex flex-col space-y-6">
              
              {/* åœ°åœ–å€åŸŸ */}
              <div className="bg-white p-5 rounded-xl shadow-md border border-stone-200 relative overflow-hidden">
                <h3 className="text-stone-500 font-bold mb-4 flex items-center tracking-wider text-sm uppercase border-b border-stone-100 pb-2 font-serif">
                  <Icons.MapPin className="w-4 h-4 mr-2 text-gold" /> 
                  æ˜¥ç§‹åˆ—åœ‹åœ–
                </h3>
                
                <div className="aspect-square bg-[#f3f1eb] rounded-lg relative border border-[#e5e2d6] shadow-inner overflow-hidden">
                  <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#444 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>

                  <svg viewBox="0 0 100 100" className="w-full h-full absolute top-0 left-0">
                    <path 
                      d="M 80 30 L 70 40 L 60 20 L 50 50 L 40 60 L 80 45" 
                      fill="none" stroke="#d6d3d1" strokeWidth="2" strokeDasharray="4"
                      className="opacity-50"
                    />
                    <path 
                      d={`M 80 30 ${currentStageIndex > 0 ? 'L 70 40' : ''} ${currentStageIndex > 1 ? 'L 60 20' : ''} ${currentStageIndex > 2 ? 'L 50 50' : ''} ${currentStageIndex > 3 ? 'L 40 60' : ''} ${currentStageIndex > 4 ? 'L 80 45' : ''}`}
                      fill="none" stroke="#b45309" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"
                      className="transition-all duration-1000 ease-in-out drop-shadow-md"
                    />
                    
                    {JOURNEY_STAGES.map((stage, idx) => {
                       const isActive = currentStageIndex === idx;
                       return (
                        <g key={stage.id} onClick={() => { setCurrentStageIndex(idx); setShowDiscussion(false); }} className="cursor-pointer">
                          
                          {/* ğŸ”´ é‡é»ï¼šä¸åœè·³å‹•çš„ç´…è‰²åœ“åœˆ (åªæœ‰ç•¶å‰ç¯€é»é¡¯ç¤º) */}
                          {isActive && (
                              <circle cx={stage.mapCoords.x} cy={stage.mapCoords.y} r="8" className="animate-ping opacity-75 fill-seal-red origin-center" />
                          )}

                          {/* å¯¦é«”åœ“é» */}
                          <circle
                            cx={stage.mapCoords.x} cy={stage.mapCoords.y}
                            r={isActive ? 4 : 2.5}
                            fill={isActive ? "#b91c1c" : "#78716c"}
                            stroke="#fff" strokeWidth="1.5"
                            className="transition-all duration-300"
                          />
                          
                          {/* åœ°åæ¨™ç±¤ */}
                          <text 
                            x={stage.mapCoords.x} y={stage.mapCoords.y + 8} 
                            textAnchor="middle" 
                            className={`text-[8px] font-serif font-bold transition-all duration-300 select-none
                                ${isActive ? 'fill-seal-red text-[10px]' : 'fill-stone-400'}`}
                          >
                            {stage.location.split(' ')[0]}
                          </text>
                        </g>
                      );
                    })}
                  </svg>
                </div>
              </div>

              {/* æ™‚é–“è»¸åˆ—è¡¨ */}
              <div className="bg-white rounded-xl shadow-md border border-stone-200 p-6 hidden lg:block relative overflow-hidden flex-1">
                 <h3 className="text-stone-500 font-bold mb-4 font-serif">ç”Ÿå‘½æ­·ç¨‹</h3>
                 <div className="space-y-4 relative border-l-2 border-stone-100 ml-3 h-full overflow-y-auto pr-2 pb-10">
                   {JOURNEY_STAGES.map((stage, idx) => (
                     <div key={stage.id} className="relative pl-6 cursor-pointer group" onClick={() => setCurrentStageIndex(idx)}>
                       <div className={`absolute -left-[9px] top-1 w-4 h-4 rounded-full border-4 transition-colors duration-300 ${idx === currentStageIndex ? 'bg-white border-gold scale-110' : 'bg-white border-stone-200 group-hover:border-stone-300'}`}></div>
                       <div className={`transition-all duration-300 ${idx === currentStageIndex ? 'text-ink font-bold translate-x-1' : 'text-stone-400 group-hover:text-stone-600'}`}>
                         <div className="font-serif text-base">{stage.title.split('ï¼š')[0]}</div>
                         <div className="text-xs mt-1">{stage.year}</div>
                       </div>
                     </div>
                   ))}
                 </div>
              </div>
            </div>

            {/* å³å´ï¼šä¸»è¦å…§å®¹ (8æ¬„) */}
            <div className="lg:col-span-8 flex flex-col">
              <div className="bg-white rounded-xl shadow-lg border border-stone-200 flex-grow overflow-hidden flex flex-col relative min-h-[600px]">
                
                {/* æ¨™é¡Œæ©«å¹… */}
                <div className="relative bg-ink h-48 flex items-center justify-center overflow-hidden">
                   <div className="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')]"></div>
                   <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                   <div className="relative z-10 text-center px-4 animate-fade-in-up">
                     <span className="inline-block px-3 py-1 bg-white/10 backdrop-blur-sm rounded border border-white/20 text-gold text-xs font-serif tracking-[0.2em] mb-3">
                        {currentStage.year}
                     </span>
                     <h2 className="text-3xl md:text-5xl font-serif font-bold text-white tracking-widest drop-shadow-md">
                        {currentStage.title.split('ï¼š')[0]}
                     </h2>
                     <p className="text-stone-400 mt-2 text-sm md:text-base font-light tracking-widest uppercase">
                        {currentStage.title.split('ï¼š')[1]}
                     </p>
                   </div>
                </div>

                <div className="p-6 md:p-10 flex-grow flex flex-col space-y-8">
                  {/* åœ°é»èˆ‡æè¿° */}
                  <div className="flex flex-col md:flex-row gap-6">
                    <div className="md:w-1/4 flex flex-col items-center md:items-start text-center md:text-left">
                        <div className="p-4 bg-stone-50 rounded-full border border-stone-200 text-gold mb-3 shadow-sm">
                            {currentStage.icon}
                        </div>
                        <div className="text-xs font-bold text-stone-400 uppercase tracking-wider">é§è¶³ä¹‹åœ°</div>
                        <div className="text-2xl font-serif font-bold text-ink">{currentStage.location.split(' ')[0]}</div>
                    </div>
                    <div className="md:w-3/4">
                        <p className="text-lg text-stone-600 leading-loose text-justify font-light">{currentStage.description}</p>
                    </div>
                  </div>

                  <hr className="border-stone-100" />

                  {/* åè¨€å¡ç‰‡ */}
                  <div className="bg-[#faf9f6] p-8 rounded-lg border border-stone-200 shadow-sm relative group">
                    <div className="absolute top-4 left-4 text-8xl font-serif text-stone-200 opacity-50 select-none pointer-events-none">â€œ</div>
                    <div className="relative z-10 pl-4 border-l-4 border-seal-red">
                        <p className="text-2xl md:text-3xl font-serif font-bold text-ink leading-relaxed mb-4">
                            {currentStage.philosophy}
                        </p>
                        <div className="flex flex-wrap gap-2 items-center">
                            <span className="px-2 py-0.5 bg-stone-200 rounded text-stone-600 text-xs font-bold">é‡‹ç¾©</span> 
                            <span className="text-stone-500 text-sm">{currentStage.philosophyMeaning}</span>
                        </div>
                    </div>

                    <div className="flex flex-wrap gap-3 mt-6 justify-end">
                         <button onClick={handleSpeakQuote} className={`flex items-center text-xs font-medium px-4 py-2 rounded border transition-colors ${isSpeaking ? 'border-seal-red text-seal-red bg-red-50' : 'border-stone-300 text-stone-500 hover:text-gold hover:border-gold'}`}>
                            {isSpeaking ? <Icons.Loader2 className="w-3.5 h-3.5 mr-2 animate-spin" /> : <Icons.Volume2 className="w-3.5 h-3.5 mr-2" />}
                            è†è½è–è¨€
                         </button>
                         <button onClick={handleGenerateAnalogy} disabled={isAnalogyLoading} className="flex items-center text-xs font-medium px-4 py-2 rounded bg-white text-jade border border-jade/30 hover:bg-jade hover:text-white transition-colors">
                            {isAnalogyLoading ? <Icons.Loader2 className="w-3.5 h-3.5 mr-2 animate-spin" /> : <Icons.Lightbulb className="w-3.5 h-3.5 mr-2" />}
                            ç¾ä»£è·å ´è§£è®€
                         </button>
                    </div>
                    {modernAnalogy && (
                        <div className="mt-4 p-4 bg-white/80 border border-jade/20 rounded text-sm text-jade/90 leading-relaxed animate-pulse">
                            {modernAnalogy}
                        </div>
                    )}
                  </div>

                  {/* æ€è€ƒé¡ŒæŒ‰éˆ• */}
                  <div className="mt-auto pt-4">
                    <button 
                      onClick={() => setShowDiscussion(!showDiscussion)}
                      className="w-full flex items-center justify-between p-4 bg-indigo-50 hover:bg-indigo-100 border border-indigo-100 rounded-lg transition-all text-indigo-900 group"
                    >
                      <div className="flex items-center font-bold">
                          <Icons.MessageCircle className="w-5 h-5 mr-3 text-indigo-600" />
                          {showDiscussion ? 'éš±è—æ€è€ƒé¡Œ' : 'é¡¯ç¤ºèª²å ‚æ€è€ƒé¡Œ'}
                      </div>
                      <Icons.ChevronRight className={`w-5 h-5 transition-transform ${showDiscussion ? 'rotate-90' : ''}`} />
                    </button>
                    {showDiscussion && (
                      <div className="mt-2 p-6 bg-indigo-900 text-indigo-50 rounded-lg shadow-inner animate-bounce-in">
                        <p className="font-serif text-lg leading-relaxed">{currentStage.discussion}</p>
                      </div>
                    )}
                  </div>
                </div>

                {/* åº•éƒ¨å°èˆª */}
                <div className="bg-stone-50 p-4 border-t border-stone-200 flex justify-between items-center">
                  <button onClick={handlePrev} disabled={isFirst} className={`flex items-center px-4 py-2 rounded-lg font-bold ${isFirst ? 'text-stone-300 cursor-not-allowed' : 'text-stone-600 hover:text-gold hover:bg-white hover:shadow-sm'}`}>
                    <Icons.ChevronLeft className="w-4 h-4 mr-1" /> ä¸Šä¸€ç« 
                  </button>
                  <div className="flex space-x-1">
                    {JOURNEY_STAGES.map((_, i) => (
                        <div key={i} className={`h-1.5 rounded-full transition-
